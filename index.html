<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AstroLab</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{margin:0;font-family:Arial,sans-serif;background:#f4f6f8;display:flex;height:100vh}
.sidebar{width:230px;background:#fff;border-right:1px solid #ddd;padding:15px}
.sidebar button{width:100%;padding:10px;margin-bottom:10px}
.main{flex:1;padding:20px;overflow:auto}
.card{background:#fff;border:1px solid #ddd;border-radius:8px;padding:12px;margin-bottom:10px}
.hidden{display:none}
.chat-box{height:300px;border:1px solid #ddd;padding:10px;overflow-y:auto;background:#fff}
</style>
</head>

<body>

<div class="sidebar">
  <h2>AstroLab</h2>
  <button onclick="switchRole('client')">Client</button>
  <button onclick="switchRole('astrologer')">Astrologer</button>
</div>

<div class="main">

<div id="clientView">
  <h3>Online Astrologers</h3>
  <div id="astrologerList"></div>
</div>

<div id="astrologerView" class="hidden">
  <h3>Astrologer Dashboard</h3>
  <label><input type="checkbox" onchange="toggleOnline(this.checked)"> Go Online</label>
  <h4>Queue</h4>
  <div id="requestList"></div>
</div>

<div id="chatView" class="hidden">
  <h3>Chat</h3>
  <div class="chat-box" id="messages"></div>
  <input id="msgInput" placeholder="Type message">
  <button onclick="sendMessage()">Send</button>
  <button id="exitBtn" onclick="exitChat()">Exit</button>
</div>

</div>

<script>
/* FIREBASE */
firebase.initializeApp({
  apiKey:"AIzaSyALzPqt1EdWG9cWeFf2gZP8Z470D0puPds",
  databaseURL:"https://astrolab-b8956-default-rtdb.firebaseio.com"
});
const db=firebase.database();

/* PERMANENT USER ID */
let userId=localStorage.getItem("astrolab_uid");
if(!userId){
  userId="user_"+Math.random().toString(36).slice(2);
  localStorage.setItem("astrolab_uid",userId);
}

/* STATE */
let role="client";
let chatId=null;
let partner=null;
let chatRef=null;
let queueRef=null;

/* ROLE SWITCH */
function switchRole(r){
  role=r;
  document.getElementById("clientView").classList.toggle("hidden",r!=="client");
  document.getElementById("astrologerView").classList.toggle("hidden",r!=="astrologer");
  document.getElementById("exitBtn").style.display=r==="client"?"inline":"none";
}

/* PRESENCE */
function toggleOnline(on){
  const ref=db.ref("presence/"+userId);
  if(on){
    ref.set({role:"astrologer",busy:false});
    ref.onDisconnect().remove();
    listenQueue();
  }else{
    ref.remove();
    if(queueRef){queueRef.off();queueRef=null;}
  }
}

/* SHOW ASTROLOGERS */
db.ref("presence").on("value",snap=>{
  const box=document.getElementById("astrologerList");
  box.innerHTML="";
  snap.forEach(s=>{
    if(s.val().role==="astrologer"){
      const c=document.createElement("div");
      c.className="card";
      c.innerHTML=`${s.key} ${s.val().busy?"(Busy)":""}<br>
      <button ${s.val().busy||s.key===userId?"disabled":""}
      onclick="requestChat('${s.key}')">Request</button>`;
      box.appendChild(c);
    }
  });
});

/* REQUEST CHAT */
function requestChat(astro){
  if(astro===userId) return;
  db.ref(`queue/${astro}/${userId}`).set({client:userId,time:Date.now()});
}

/* ASTROLOGER QUEUE */
function listenQueue(){
  queueRef=db.ref("queue/"+userId);
  queueRef.on("value",snap=>{
    const box=document.getElementById("requestList");
    box.innerHTML="";
    snap.forEach(r=>{
      const c=r.val().client;
      const d=document.createElement("div");
      d.className="card";
      d.innerHTML=`From ${c}<br>
      <button onclick="accept('${c}')">Accept</button>
      <button onclick="reject('${c}')">Reject</button>`;
      box.appendChild(d);
    });
  });
}

/* ACCEPT */
function accept(client){
  if(chatId) return;
  chatId=db.ref().push().key;
  partner=client;
  db.ref("presence/"+userId).update({busy:true});
  db.ref("chats/"+chatId).set({active:true});
  db.ref("currentChat/"+client).set(chatId);
  db.ref("queue/"+userId+"/"+client).remove();
  openChat(chatId);
}

/* REJECT */
function reject(client){
  db.ref("queue/"+userId+"/"+client).remove();
}

/* CLIENT LISTEN */
db.ref("currentChat/"+userId).on("value",s=>{
  if(s.exists()){
    chatId=s.val();
    openChat(chatId);
  }
});

/* CHAT */
function openChat(id){
  document.getElementById("chatView").classList.remove("hidden");
  const box=document.getElementById("messages");
  box.innerHTML="";
  if(chatRef) chatRef.off();
  chatRef=db.ref("chats/"+id+"/messages");
  chatRef.on("child_added",s=>{
    const p=document.createElement("div");
    p.textContent=s.val().from+": "+s.val().text;
    box.appendChild(p);
  });
}

/* SEND */
function sendMessage(){
  if(!chatId) return;
  db.ref("chats/"+chatId+"/messages").push({from:userId,text:msgInput.value});
  msgInput.value="";
}

/* EXIT */
function exitChat(){
  if(chatRef) chatRef.off();
  db.ref("chats/"+chatId).remove();
  db.ref("currentChat/"+userId).remove();
  if(role==="astrologer"){
    db.ref("presence/"+userId).update({busy:false});
    if(partner) db.ref("currentChat/"+partner).remove();
  }
  chatId=null;partner=null;
  document.getElementById("chatView").classList.add("hidden");
}
</script>

</body>
</html>
