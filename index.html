<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AstroLab</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- ================= FIREBASE SDK ================= -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
/* ================= BASIC RESET ================= */
* { box-sizing: border-box; }

/* ================= LAYOUT ================= */
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #f4f6f8;
  display: flex;
  height: 100vh;
}

.sidebar {
  width: 240px;
  background: #ffffff;
  border-right: 1px solid #ddd;
  padding: 15px;
}

.sidebar h2 {
  margin: 0 0 20px 0;
}

.sidebar button {
  width: 100%;
  padding: 10px;
  margin-bottom: 10px;
  cursor: pointer;
}

.main {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
}

/* ================= CARDS ================= */
.card {
  background: #ffffff;
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 10px;
}

/* ================= CHAT ================= */
.chat-box {
  height: 320px;
  border: 1px solid #ddd;
  background: #fff;
  padding: 10px;
  overflow-y: auto;
  margin-bottom: 10px;
}

/* ================= UTIL ================= */
.hidden { display: none; }

input, button {
  padding: 8px;
  margin-top: 5px;
}
</style>
</head>

<body>

<!-- ================= SIDEBAR ================= -->
<div class="sidebar">
  <h2>AstroLab</h2>
  <button onclick="switchRole('client')">Client</button>
  <button onclick="switchRole('astrologer')">Astrologer</button>
</div>

<!-- ================= MAIN ================= -->
<div class="main">

  <!-- CLIENT VIEW -->
  <div id="clientView">
    <h3>Online Astrologers</h3>
    <div id="astrologerList"></div>
  </div>

  <!-- ASTROLOGER VIEW -->
  <div id="astrologerView" class="hidden">
    <h3>Astrologer Dashboard</h3>
    <label>
      <input type="checkbox" onchange="toggleOnline(this.checked)"> Go Online
    </label>
    <h4>Chat Queue</h4>
    <div id="queueList"></div>
  </div>

  <!-- CHAT VIEW -->
  <div id="chatView" class="hidden">
    <h3>Live Chat</h3>
    <div class="chat-box" id="messages"></div>
    <input id="msgInput" placeholder="Type message..." />
    <br>
    <button onclick="sendMessage()">Send</button>
    <button onclick="exitChat()">Exit Chat</button>
  </div>

</div>

<script>
/* =====================================================
   üî• FIREBASE CONFIG ‚Äî FULL & EXPLICIT
   ===================================================== */
const firebaseConfig = {
  apiKey: "AIzaSyALzPqt1EdWG9cWeFf2gZP8Z470D0puPds",
  authDomain: "astrolab-b8956.firebaseapp.com",
  databaseURL: "https://astrolab-b8956-default-rtdb.firebaseio.com",
  projectId: "astrolab-b8956",
  storageBucket: "astrolab-b8956.appspot.com",
  messagingSenderId: "000000000000",
  appId: "1:000000000000:web:000000000000"
};

/* ================= INIT ================= */
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* =====================================================
   üß† STATE
   ===================================================== */
const userId = "user_" + Math.random().toString(36).slice(2);
let role = "client";
let chatId = null;
let partnerId = null;
let chatRef = null;

/* =====================================================
   üîÅ ROLE SWITCH
   ===================================================== */
function switchRole(r) {
  role = r;
  clientView.classList.toggle("hidden", r !== "client");
  astrologerView.classList.toggle("hidden", r !== "astrologer");
  chatView.classList.add("hidden");
}

/* =====================================================
   üåê PRESENCE (ASTROLOGER)
   ===================================================== */
function toggleOnline(isOnline) {
  const ref = db.ref("presence/" + userId);
  if (isOnline) {
    ref.set({ role: "astrologer", busy: false });
    ref.onDisconnect().remove();
  } else {
    ref.remove();
  }
}

/* =====================================================
   üëÅ SHOW ONLINE ASTROLOGERS (CLIENT)
   ===================================================== */
db.ref("presence").on("value", snap => {
  astrologerList.innerHTML = "";
  snap.forEach(child => {
    const data = child.val();
    if (data.role === "astrologer") {
      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML = `
        <strong>${child.key}</strong>
        ${data.busy ? "(Busy)" : "(Online)"}<br>
        <button onclick="requestChat('${child.key}')" 
          ${child.key === userId || data.busy ? "disabled" : ""}>
          Request Chat
        </button>
      `;
      astrologerList.appendChild(div);
    }
  });
});

/* =====================================================
   üì© CLIENT ‚Üí REQUEST CHAT
   ===================================================== */
function requestChat(astrologerId) {
  if (astrologerId === userId) {
    alert("You cannot chat with yourself");
    return;
  }
  db.ref("queue/" + astrologerId).push({
    client: userId,
    time: Date.now()
  });
  alert("Chat request sent");
}

/* =====================================================
   üì• ASTROLOGER QUEUE LISTENER (ALWAYS ON)
   ===================================================== */
db.ref("queue/" + userId).on("value", snap => {
  queueList.innerHTML = "";
  snap.forEach(child => {
    const data = child.val();
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      Request from ${data.client}<br>
      <button onclick="acceptChat('${child.key}','${data.client}')">
        Accept
      </button>
    `;
    queueList.appendChild(div);
  });
});

/* =====================================================
   ‚úÖ ACCEPT CHAT
   ===================================================== */
function acceptChat(queueKey, clientId) {
  if (chatId) {
    alert("Already in a chat");
    return;
  }

  chatId = db.ref().push().key;
  partnerId = clientId;

  db.ref("presence/" + userId).update({ busy: true });
  db.ref("queue/" + userId + "/" + queueKey).remove();

  db.ref("currentChat/" + userId).set(chatId);
  db.ref("currentChat/" + clientId).set(chatId);

  db.ref("chats/" + chatId).set({
    astrologer: userId,
    client: clientId
  });
}

/* =====================================================
   üîî CHAT ASSIGNMENT (BOTH SIDES)
   ===================================================== */
db.ref("currentChat/" + userId).on("value", snap => {
  if (snap.exists()) {
    chatId = snap.val();
    openChat(chatId);
  }
});

/* =====================================================
   üí¨ OPEN CHAT
   ===================================================== */
function openChat(id) {
  chatView.classList.remove("hidden");
  messages.innerHTML = "";

  if (chatRef) chatRef.off();

  chatRef = db.ref("messages/" + id);
  chatRef.on("child_added", snap => {
    const msg = snap.val();
    const div = document.createElement("div");
    div.textContent = msg.from + ": " + msg.text;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
  });
}

/* =====================================================
   ‚úâ SEND MESSAGE
   ===================================================== */
function sendMessage() {
  if (!chatId) return;
  const text = msgInput.value.trim();
  if (!text) return;

  db.ref("messages/" + chatId).push({
    from: userId,
    text: text,
    time: Date.now()
  });

  msgInput.value = "";
}

/* =====================================================
   ‚ùå EXIT CHAT (SYNC BOTH)
   ===================================================== */
function exitChat() {
  if (!chatId) return;

  db.ref("currentChat/" + userId).remove();
  if (partnerId) db.ref("currentChat/" + partnerId).remove();
  db.ref("messages/" + chatId).remove();
  db.ref("chats/" + chatId).remove();

  if (role === "astrologer") {
    db.ref("presence/" + userId).update({ busy: false });
  }

  chatId = null;
  partnerId = null;
  chatView.classList.add("hidden");
}
</script>

</body>
</html>
