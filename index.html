<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AstroLab</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- ================= FIREBASE SDK ================= -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
* { box-sizing: border-box; }
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #f4f6f8;
  display: flex;
  height: 100vh;
}
.sidebar {
  width: 240px;
  background: #fff;
  border-right: 1px solid #ddd;
  padding: 15px;
}
.main {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
}
.card {
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 10px;
}
.chat-box {
  height: 320px;
  border: 1px solid #ddd;
  background: #fff;
  padding: 10px;
  overflow-y: auto;
  margin-bottom: 10px;
}
.hidden { display: none; }
input, button { padding: 8px; margin-top: 5px; }
</style>
</head>

<body>

<div class="sidebar">
  <h2>AstroLab</h2>
  <button onclick="switchRole('client')">Client</button>
  <button onclick="switchRole('astrologer')">Astrologer</button>
</div>

<div class="main">

  <div id="clientView">
    <h3>Online Astrologers</h3>
    <div id="astrologerList"></div>
  </div>

  <div id="astrologerView" class="hidden">
    <h3>Astrologer Dashboard</h3>
    <label>
      <input type="checkbox" onchange="toggleOnline(this.checked)"> Go Online
    </label>
    <h4>Chat Queue</h4>
    <div id="queueList"></div>
  </div>

  <div id="chatView" class="hidden">
    <h3>Live Chat</h3>
    <div class="chat-box" id="messages"></div>
    <input id="msgInput" placeholder="Type message..." />
    <br>
    <button onclick="sendMessage()">Send</button>
    <button onclick="exitChat()">Exit Chat</button>
  </div>

</div>

<script>
/* ================= FIREBASE CONFIG ================= */
const firebaseConfig = {
  apiKey: "AIzaSyALzPqt1EdWG9cWeFf2gZP8Z470D0puPds",
  authDomain: "astrolab-b8956.firebaseapp.com",
  databaseURL: "https://astrolab-b8956-default-rtdb.firebaseio.com",
  projectId: "astrolab-b8956",
  storageBucket: "astrolab-b8956.appspot.com",
  messagingSenderId: "000000000000",
  appId: "1:000000000000:web:000000000000"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ================= STATE ================= */
const userId = "user_" + Math.random().toString(36).slice(2);
let role = "client";
let chatId = null;
let partnerId = null;
let chatRef = null;
let queueRef = null;

/* ================= ROLE SWITCH ================= */
function switchRole(r) {
  role = r;
  clientView.classList.toggle("hidden", r !== "client");
  astrologerView.classList.toggle("hidden", r !== "astrologer");
  chatView.classList.add("hidden");
}

/* ================= ASTROLOGER ONLINE ================= */
function toggleOnline(isOnline) {
  const ref = db.ref("presence/" + userId);

  if (isOnline) {
    ref.set({ role: "astrologer", busy: false });
    ref.onDisconnect().remove();
    startQueueListener(); // ðŸ”¥ FIX
  } else {
    ref.remove();
    stopQueueListener();
  }
}

/* ================= QUEUE LISTENER (FIXED) ================= */
function startQueueListener() {
  queueList.innerHTML = "";
  queueRef = db.ref("queue/" + userId);

  queueRef.off();
  queueRef.on("child_added", snap => {
    const data = snap.val();
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      Request from ${data.client}<br>
      <button onclick="acceptChat('${snap.key}','${data.client}')">
        Accept
      </button>
    `;
    queueList.appendChild(div);
  });
}

function stopQueueListener() {
  if (queueRef) queueRef.off();
  queueList.innerHTML = "";
}

/* ================= CLIENT VIEW ================= */
db.ref("presence").on("value", snap => {
  astrologerList.innerHTML = "";
  snap.forEach(child => {
    const data = child.val();
    if (data.role === "astrologer") {
      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML = `
        <strong>${child.key}</strong>
        ${data.busy ? "(Busy)" : "(Online)"}<br>
        <button onclick="requestChat('${child.key}')" 
          ${data.busy ? "disabled" : ""}>
          Request Chat
        </button>
      `;
      astrologerList.appendChild(div);
    }
  });
});

/* ================= SEND REQUEST ================= */
function requestChat(astrologerId) {
  db.ref("queue/" + astrologerId).push({
    client: userId,
    time: Date.now()
  });
  alert("Chat request sent");
}

/* ================= ACCEPT CHAT ================= */
function acceptChat(queueKey, clientId) {
  chatId = db.ref().push().key;
  partnerId = clientId;

  db.ref("presence/" + userId).update({ busy: true });
  db.ref("queue/" + userId + "/" + queueKey).remove();

  db.ref("currentChat/" + userId).set(chatId);
  db.ref("currentChat/" + clientId).set(chatId);
}

/* ================= CHAT ASSIGN ================= */
db.ref("currentChat/" + userId).on("value", snap => {
  if (snap.exists()) openChat(snap.val());
});

/* ================= OPEN CHAT ================= */
function openChat(id) {
  chatView.classList.remove("hidden");
  messages.innerHTML = "";
  chatRef = db.ref("messages/" + id);

  chatRef.off();
  chatRef.on("child_added", snap => {
    const msg = snap.val();
    const div = document.createElement("div");
    div.textContent = msg.from + ": " + msg.text;
    messages.appendChild(div);
  });
}

/* ================= SEND MESSAGE ================= */
function sendMessage() {
  if (!chatId) return;
  const text = msgInput.value.trim();
  if (!text) return;

  db.ref("messages/" + chatId).push({
    from: userId,
    text,
    time: Date.now()
  });
  msgInput.value = "";
}

/* ================= EXIT CHAT ================= */
function exitChat() {
  db.ref("currentChat/" + userId).remove();
  if (partnerId) db.ref("currentChat/" + partnerId).remove();
  if (role === "astrologer") {
    db.ref("presence/" + userId).update({ busy: false });
  }
  chatId = null;
  partnerId = null;
  chatView.classList.add("hidden");
}
</script>

</body>
</html>
