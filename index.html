<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AstroLab â€“ Live Astrology Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #ffffff;
  color: #222;
}
header {
  padding: 14px;
  border-bottom: 1px solid #ddd;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
button {
  padding: 8px 12px;
  cursor: pointer;
}
.container {
  display: flex;
  height: calc(100vh - 60px);
}
.sidebar {
  width: 260px;
  border-right: 1px solid #ddd;
  padding: 10px;
  overflow-y: auto;
}
.main {
  flex: 1;
  display: flex;
  flex-direction: column;
}
.card {
  border: 1px solid #ddd;
  padding: 10px;
  margin-bottom: 10px;
}
.online {
  color: green;
}
.offline {
  color: gray;
}
.chat {
  flex: 1;
  padding: 10px;
  overflow-y: auto;
  border-bottom: 1px solid #ddd;
}
.chat input {
  width: 80%;
}
.hidden {
  display: none;
}
.queue-item {
  border-bottom: 1px solid #eee;
  padding: 6px;
}
</style>
</head>

<body>

<header>
  <div><strong>AstroLab</strong></div>
  <div>
    Role:
    <select id="roleSelect">
      <option value="client">Client</option>
      <option value="astrologer">Astrologer</option>
    </select>
    <button id="onlineBtn" class="hidden">Go Online</button>
  </div>
</header>

<div class="container">

  <!-- SIDEBAR -->
  <div class="sidebar">
    <h3>Astrologers Online</h3>
    <div id="astrologerList"></div>

    <h3 class="hidden" id="queueTitle">Chat Requests</h3>
    <div id="queueList"></div>
  </div>

  <!-- MAIN -->
  <div class="main">

    <div class="chat" id="chatBox"></div>

    <div style="padding:10px;">
      <input type="text" id="msgInput" placeholder="Type message..." />
      <button id="sendBtn">Send</button>
      <button id="exitBtn" class="hidden">Exit Chat</button>
    </div>

  </div>

</div>

<script>
/* ================= FIREBASE CONFIG ================= */
const firebaseConfig = {
  apiKey: "AIzaSyALzPqt1EdWG9cWeFf2gZP8Z470D0puPds",
  authDomain: "astrolab-b8956.firebaseapp.com",
  databaseURL: "https://astrolab-b8956-default-rtdb.firebaseio.com",
  projectId: "astrolab-b8956"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ================= STATE ================= */
const uid = "user_" + Math.random().toString(36).substr(2, 9);
let role = "client";
let online = false;
let activeChatId = null;

/* ================= ELEMENTS ================= */
const roleSelect = document.getElementById("roleSelect");
const onlineBtn = document.getElementById("onlineBtn");
const astrologerList = document.getElementById("astrologerList");
const queueList = document.getElementById("queueList");
const queueTitle = document.getElementById("queueTitle");
const chatBox = document.getElementById("chatBox");
const msgInput = document.getElementById("msgInput");
const sendBtn = document.getElementById("sendBtn");
const exitBtn = document.getElementById("exitBtn");

/* ================= ROLE CHANGE ================= */
roleSelect.onchange = () => {
  role = roleSelect.value;
  cleanup();
  if (role === "astrologer") {
    onlineBtn.classList.remove("hidden");
    queueTitle.classList.remove("hidden");
  } else {
    onlineBtn.classList.add("hidden");
    queueTitle.classList.add("hidden");
  }
};

/* ================= ONLINE TOGGLE ================= */
onlineBtn.onclick = () => {
  online = !online;
  onlineBtn.innerText = online ? "Go Offline" : "Go Online";
  db.ref("astrologers/" + uid).set({
    online,
    busy: false
  });
};

/* ================= LIST ASTROLOGERS ================= */
db.ref("astrologers").on("value", snap => {
  astrologerList.innerHTML = "";
  snap.forEach(a => {
    const data = a.val();
    if (data.online && !data.busy) {
      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML = `
        <div class="online">Astrologer ${a.key}</div>
        ${role === "client" ? `<button onclick="requestChat('${a.key}')">Request Chat</button>` : ""}
      `;
      astrologerList.appendChild(div);
    }
  });
});

/* ================= REQUEST CHAT ================= */
function requestChat(astrologerId) {
  if (role !== "client") return;
  if (astrologerId === uid) return;

  const reqId = db.ref("queue/" + astrologerId).push().key;
  db.ref("queue/" + astrologerId + "/" + reqId).set({
    client: uid,
    time: Date.now()
  });
}

/* ================= QUEUE LISTENER ================= */
db.ref("queue").on("value", snap => {
  if (role !== "astrologer") return;
  queueList.innerHTML = "";
  const myQueue = snap.child(uid);
  if (!myQueue.exists()) return;

  myQueue.forEach(req => {
    const div = document.createElement("div");
    div.className = "queue-item";
    div.innerHTML = `
      Client ${req.val().client}
      <button onclick="acceptChat('${req.key}','${req.val().client}')">Accept</button>
    `;
    queueList.appendChild(div);
  });
});

/* ================= ACCEPT CHAT ================= */
function acceptChat(reqKey, clientId) {
  if (activeChatId) return;

  const chatId = "chat_" + Date.now();
  activeChatId = chatId;

  db.ref("chats/" + chatId).set({
    astrologer: uid,
    client: clientId
  });

  db.ref("astrologers/" + uid + "/busy").set(true);
  db.ref("queue/" + uid + "/" + reqKey).remove();
  listenChat(chatId);
}

/* ================= CHAT ================= */
function listenChat(chatId) {
  chatBox.innerHTML = "";
  exitBtn.classList.remove("hidden");

  db.ref("messages/" + chatId).on("child_added", snap => {
    const msg = document.createElement("div");
    msg.textContent = snap.val().sender + ": " + snap.val().text;
    chatBox.appendChild(msg);
    chatBox.scrollTop = chatBox.scrollHeight;
  });
}

/* ================= SEND MESSAGE ================= */
sendBtn.onclick = () => {
  if (!activeChatId || !msgInput.value) return;
  db.ref("messages/" + activeChatId).push({
    sender: uid,
    text: msgInput.value
  });
  msgInput.value = "";
};

/* ================= EXIT CHAT ================= */
exitBtn.onclick = () => {
  if (role === "client") {
    db.ref("chats/" + activeChatId).remove();
    db.ref("messages/" + activeChatId).remove();
  }
  if (role === "astrologer") {
    db.ref("astrologers/" + uid + "/busy").set(false);
  }
  activeChatId = null;
  chatBox.innerHTML = "";
  exitBtn.classList.add("hidden");
};

/* ================= CLEANUP ================= */
function cleanup() {
  db.ref("astrologers/" + uid).remove();
  activeChatId = null;
  chatBox.innerHTML = "";
}
</script>

</body>
</html>
