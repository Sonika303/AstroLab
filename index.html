<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AstroLab</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #f4f6f8;
  display: flex;
  height: 100vh;
}

.sidebar {
  width: 230px;
  background: #ffffff;
  border-right: 1px solid #ddd;
  padding: 15px;
}

.sidebar h2 {
  margin-bottom: 20px;
}

.sidebar button {
  width: 100%;
  padding: 10px;
  margin-bottom: 10px;
  cursor: pointer;
}

.main {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
}

.card {
  background: #ffffff;
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 10px;
}

.hidden { display: none; }

.chat-box {
  height: 300px;
  border: 1px solid #ddd;
  padding: 10px;
  overflow-y: auto;
  background: #fff;
}

input, button {
  padding: 8px;
  margin-top: 5px;
}
</style>
</head>

<body>

<div class="sidebar">
  <h2>AstroLab</h2>
  <button onclick="switchRole('client')">Client</button>
  <button onclick="switchRole('astrologer')">Astrologer</button>
</div>

<div class="main">

  <!-- CLIENT VIEW -->
  <div id="clientView">
    <h3>Online Astrologers</h3>
    <div id="astrologerList"></div>
  </div>

  <!-- ASTROLOGER VIEW -->
  <div id="astrologerView" class="hidden">
    <h3>Astrologer Dashboard</h3>
    <label>
      <input type="checkbox" onchange="toggleOnline(this.checked)"> Go Online
    </label>

    <h4>Chat Requests</h4>
    <div id="requestList"></div>
  </div>

  <!-- CHAT -->
  <div id="chatView" class="hidden">
    <h3>Live Chat</h3>
    <div class="chat-box" id="messages"></div>
    <input id="msgInput" placeholder="Type message">
    <br>
    <button onclick="sendMessage()">Send</button>
    <button onclick="endChat()">End Chat</button>
  </div>

</div>

<script>
/* ================= FIREBASE CONFIG ================= */
const firebaseConfig = {
  apiKey: "AIzaSyALzPqt1EdWG9cWeFf2gZP8Z470D0puPds",
  authDomain: "astrolab-b8956.firebaseapp.com",
  databaseURL: "https://astrolab-b8956-default-rtdb.firebaseio.com",
  projectId: "astrolab-b8956"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ================= STATE ================= */
const userId = "user_" + Math.random().toString(36).slice(2);
let role = "client";
let chatId = null;

/* ================= ROLE SWITCH ================= */
function switchRole(r) {
  role = r;
  document.getElementById("clientView").classList.toggle("hidden", r !== "client");
  document.getElementById("astrologerView").classList.toggle("hidden", r !== "astrologer");
}

/* ================= PRESENCE ================= */
function toggleOnline(isOnline) {
  const ref = db.ref("presence/" + userId);
  if (isOnline) {
    ref.set({ role: "astrologer" });
    ref.onDisconnect().remove();
    listenForRequests();
  } else {
    ref.remove();
  }
}

/* ================= SHOW ONLINE ASTROLOGERS ================= */
db.ref("presence").on("value", snap => {
  const list = document.getElementById("astrologerList");
  list.innerHTML = "";
  snap.forEach(c => {
    if (c.val().role === "astrologer") {
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <strong>${c.key}</strong><br>
        <button onclick="requestChat('${c.key}')">Request Chat</button>
      `;
      list.appendChild(card);
    }
  });
});

/* ================= CHAT REQUEST ================= */
function requestChat(astrologerId) {
  const reqId = db.ref().push().key;
  db.ref(`requests/${astrologerId}/${reqId}`).set({
    from: userId
  });
  alert("Chat request sent");
}

/* ================= ASTROLOGER REQUEST INBOX ================= */
function listenForRequests() {
  db.ref("requests/" + userId).on("value", snap => {
    const box = document.getElementById("requestList");
    box.innerHTML = "";
    snap.forEach(r => {
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        Request from ${r.val().from}<br>
        <button onclick="acceptRequest('${r.key}','${r.val().from}')">Accept</button>
        <button onclick="rejectRequest('${r.key}')">Reject</button>
      `;
      box.appendChild(card);
    });
  });
}

function acceptRequest(reqId, clientId) {
  chatId = db.ref().push().key;
  db.ref(`chats/${chatId}`).set({ active: true });
  db.ref(`requests/${userId}/${reqId}`).remove();
  openChat(chatId);
}

function rejectRequest(reqId) {
  db.ref(`requests/${userId}/${reqId}`).remove();
}

/* ================= CHAT ================= */
function openChat(id) {
  document.getElementById("chatView").classList.remove("hidden");
  const box = document.getElementById("messages");
  box.innerHTML = "";

  db.ref(`chats/${id}/messages`).on("child_added", snap => {
    const p = document.createElement("div");
    p.textContent = snap.val().from + ": " + snap.val().text;
    box.appendChild(p);
  });
}

function sendMessage() {
  if (!chatId) return;
  const text = msgInput.value.trim();
  if (!text) return;
  db.ref(`chats/${chatId}/messages`).push({
    from: userId,
    text
  });
  msgInput.value = "";
}

function endChat() {
  if (!chatId) return;
  db.ref(`chats/${chatId}`).remove();
  chatId = null;
  document.getElementById("chatView").classList.add("hidden");
}
</script>

</body>
</html>
