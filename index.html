<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AstroLab</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
* { box-sizing:border-box; }
body {
  margin:0; font-family:Arial; background:#f4f6f8;
  display:flex; height:100vh; overflow:hidden;
}
.sidebar {
  width:230px; background:#fff; border-right:1px solid #ddd;
  padding:15px; display:flex; flex-direction:column; gap:10px;
}
.sidebar button {
  padding:10px; border:none; background:#007bff; color:#fff;
  border-radius:6px; cursor:pointer;
}
.main { flex:1; padding:20px; overflow-y:auto; }
.card {
  background:#fff; border-radius:8px; padding:15px;
  margin-bottom:15px; box-shadow:0 2px 6px rgba(0,0,0,.1);
}
.chat-box {
  height:320px; border:1px solid #ddd; background:#fff;
  padding:10px; overflow-y:auto; margin-bottom:10px;
}
.message {
  margin-bottom:6px; padding:6px 10px; border-radius:6px;
  background:#e9ecef; max-width:75%;
}
.message.self { background:#007bff; color:#fff; margin-left:auto; }
.message.system { background:#fff3cd; font-style:italic; }
.hidden { display:none; }
input, textarea, button { width:100%; padding:8px; margin-top:5px; }
#timer { font-weight:bold; margin-bottom:10px; }
</style>
</head>

<body>

<div class="sidebar">
  <h2>AstroLab</h2>
  <button onclick="switchRole('client')">Client</button>
  <button onclick="switchRole('astrologer')">Astrologer</button>
</div>

<div class="main">

<!-- AUTH -->
<div id="authCard" class="card">
  <h3>Login / Signup</h3>
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <input id="username" placeholder="Username">
  <button onclick="signup()">Signup</button>
  <button onclick="login()">Login</button>
  <p id="error"></p>
</div>

<!-- PROFILE -->
<div id="profileCard" class="card hidden">
  <h3>Profile</h3>
  <input id="p_username" placeholder="Username">
  <button onclick="saveProfile()">Save</button>
  <button onclick="logout()">Logout</button>
</div>

<!-- CLIENT -->
<div id="clientView" class="hidden">
  <h3>Online Astrologers</h3>
  <div id="astrologerList"></div>
</div>

<!-- ASTROLOGER -->
<div id="astrologerView" class="hidden">
  <h3>Astrologer Dashboard</h3>
  <label><input type="checkbox" onchange="toggleOnline(this.checked)"> Go Online</label>
  <h4>Queue</h4>
  <div id="queueList"></div>
</div>

<!-- CHAT -->
<div id="chatView" class="hidden">
  <h3>Live Chat</h3>
  <div id="timer">00:00</div>
  <div class="chat-box" id="messages"></div>
  <input id="msgInput" placeholder="Type message">
  <button onclick="sendMessage()">Send</button>
  <button onclick="confirmEndChat()">End Chat</button>
</div>

</div>

<script>
/* FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyALzPqt1EdWG9cWeFf2gZP8Z470D0puPds",
  authDomain: "astrolab-b8956.firebaseapp.com",
  databaseURL: "https://astrolab-b8956-default-rtdb.firebaseio.com",
  projectId: "astrolab-b8956"
});
const auth=firebase.auth(), db=firebase.database();

/* STATE */
let userId=null, role="client", chatId=null, partnerId=null;
let chatRef=null, timerInt=null, chatStart=0;
const $=id=>document.getElementById(id);

/* AUTH */
auth.onAuthStateChanged(u=>{
  if(!u) return;
  userId=u.uid;
  $("authCard").classList.add("hidden");
  $("profileCard").classList.remove("hidden");
  $("clientView").classList.remove("hidden");
  loadProfile();
  listenCurrentChat();
});

/* SIGNUP / LOGIN */
function signup(){
  auth.createUserWithEmailAndPassword(email.value,password.value)
  .then(r=>{
    db.ref("presence/"+r.user.uid).set({
      username:username.value.toLowerCase(),
      role:"user", busy:false
    });
  }).catch(e=>error.textContent=e.message);
}
function login(){ auth.signInWithEmailAndPassword(email.value,password.value); }
function logout(){ auth.signOut(); }

/* PROFILE */
function loadProfile(){
  db.ref("presence/"+userId).once("value").then(s=>{
    p_username.value=s.val().username;
  });
}
function saveProfile(){
  db.ref("presence/"+userId).update({ username:p_username.value.toLowerCase() });
}

/* ROLE */
function switchRole(r){
  role=r;
  $("clientView").classList.toggle("hidden",r!=="client");
  $("astrologerView").classList.toggle("hidden",r!=="astrologer");
}

/* ASTROLOGER ONLINE */
function toggleOnline(v){
  db.ref("presence/"+userId).update({ role:v?"astrologer":"user", busy:false });
  v?listenQueue():$("queueList").innerHTML="";
}

/* QUEUE */
function listenQueue(){
  const ref=db.ref("requests/"+userId);
  ref.off();
  ref.on("child_added",s=>{
    const d=s.val();
    const div=document.createElement("div");
    div.className="card";
    div.innerHTML=`Request from ${d.client}
      <button onclick="acceptChat('${s.key}','${d.client}')">Accept</button>`;
    $("queueList").appendChild(div);
  });
}

/* CLIENT VIEW */
db.ref("presence").on("value",s=>{
  $("astrologerList").innerHTML="";
  s.forEach(c=>{
    const d=c.val();
    if(d.role==="astrologer"){
      const div=document.createElement("div");
      div.className="card";
      div.innerHTML=`<b>${d.username}</b> ${d.busy?"(Busy)":"(Online)"}<br>
      <button ${d.busy?"disabled":""} onclick="requestChat('${c.key}')">Request Chat</button>`;
      $("astrologerList").appendChild(div);
    }
  });
});

/* REQUEST */
function requestChat(aid){
  db.ref("presence/"+aid).once("value").then(s=>{
    if(s.val().busy) return alert("Astrologer is busy");
    db.ref("requests/"+aid).push({ client:userId, time:Date.now() });
  });
}

/* ACCEPT */
function acceptChat(qid,client){
  chatId=db.ref().push().key;
  partnerId=client;
  chatStart=Date.now();
  db.ref("chats/"+chatId).set({ startedAt:chatStart });
  db.ref("currentChat/"+userId).set(chatId);
  db.ref("currentChat/"+client).set(chatId);
  db.ref("presence/"+userId).update({ busy:true });
  db.ref("requests/"+userId+"/"+qid).remove();
}

/* CURRENT CHAT */
function listenCurrentChat(){
  db.ref("currentChat/"+userId).on("value",s=>{
    if(!s.exists()) return;
    openChat(s.val());
  });
}

/* OPEN CHAT */
function openChat(id){
  chatId=id;
  $("chatView").classList.remove("hidden");
  $("messages").innerHTML="";
  chatRef=db.ref("chats/"+id+"/messages");
  chatRef.on("child_added",s=>{
    const m=s.val();
    const div=document.createElement("div");
    div.className="message "+(m.system?"system":m.from===userId?"self":"");
    div.textContent=m.text;
    $("messages").appendChild(div);
  });
  startTimer();
}

/* TIMER */
function startTimer(){
  clearInterval(timerInt);
  timerInt=setInterval(()=>{
    const sec=Math.floor((Date.now()-chatStart)/1000);
    $("timer").textContent=
      String(Math.floor(sec/60)).padStart(2,"0")+":"+
      String(sec%60).padStart(2,"0");
  },1000);
}

/* MESSAGE */
function sendMessage(){
  if(!chatId) return;
  db.ref("chats/"+chatId+"/messages").push({
    from:userId, text:msgInput.value, time:Date.now()
  });
  msgInput.value="";
}

/* END CHAT */
function confirmEndChat(){
  if(!confirm("End chat? Credits will be deducted.")) return;
  endChat(role==="client"?"CLIENT":"ASTROLOGER");
}
function endChat(by){
  db.ref("chats/"+chatId).update({ ended:true, endedBy:by });
  db.ref("chats/"+chatId+"/messages").push({
    system:true,
    text:`Chat ended by ${by}. Credits have been deducted.`
  });
  db.ref("currentChat/"+userId).remove();
  db.ref("presence/"+userId).update({ busy:false });
  clearInterval(timerInt);
  $("chatView").classList.add("hidden");
}
</script>

</body>
</html>
