<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AstroLab</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #f4f6f8;
  display: flex;
  height: 100vh;
}
.sidebar {
  width: 230px;
  background: #ffffff;
  border-right: 1px solid #ddd;
  padding: 15px;
}
.sidebar h2 {
  margin-bottom: 20px;
}
.sidebar button {
  width: 100%;
  padding: 10px;
  margin-bottom: 10px;
  cursor: pointer;
}
.main {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
}
.card {
  background: #ffffff;
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 10px;
}
.hidden { display: none; }
.chat-box {
  height: 300px;
  border: 1px solid #ddd;
  padding: 10px;
  overflow-y: auto;
  background: #fff;
}
input, button {
  padding: 8px;
  margin-top: 5px;
}
</style>
</head>

<body>

<div class="sidebar">
  <h2>AstroLab</h2>
  <button onclick="switchRole('client')">Client</button>
  <button onclick="switchRole('astrologer')">Astrologer</button>
</div>

<div class="main">

  <!-- CLIENT VIEW -->
  <div id="clientView">
    <h3>Online Astrologers</h3>
    <div id="astrologerList"></div>
  </div>

  <!-- ASTROLOGER VIEW -->
  <div id="astrologerView" class="hidden">
    <h3>Astrologer Dashboard</h3>
    <label>
      <input type="checkbox" onchange="toggleOnline(this.checked)"> Go Online
    </label>
    <h4>Chat Requests Queue</h4>
    <div id="requestList"></div>
  </div>

  <!-- CHAT VIEW -->
  <div id="chatView" class="hidden">
    <h3>Live Chat</h3>
    <div class="chat-box" id="messages"></div>
    <input id="msgInput" placeholder="Type message">
    <br>
    <button onclick="sendMessage()">Send</button>
    <button id="exitBtn" onclick="exitChat()">Exit Chat</button>
  </div>

</div>

<script>
/* ================= FIREBASE CONFIG ================= */
const firebaseConfig = {
  apiKey: "AIzaSyALzPqt1EdWG9cWeFf2gZP8Z470D0puPds",
  authDomain: "astrolab-b8956.firebaseapp.com",
  databaseURL: "https://astrolab-b8956-default-rtdb.firebaseio.com",
  projectId: "astrolab-b8956"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ================= STATE ================= */
const userId = "user_" + Math.random().toString(36).slice(2);
let role = "client";
let chatId = null;
let currentPartner = null;
let chatListener = null;

/* ================= NOTIFICATIONS ================= */
if ("Notification" in window) Notification.requestPermission();

/* ================= ROLE SWITCH ================= */
function switchRole(r) {
  role = r;
  clientView.classList.toggle("hidden", r !== "client");
  astrologerView.classList.toggle("hidden", r !== "astrologer");
  chatView.classList.add("hidden");
  exitBtn.style.display = r === "client" ? "inline-block" : "none";
}

/* ================= PRESENCE ================= */
function toggleOnline(isOnline) {
  const ref = db.ref("presence/" + userId);
  if (isOnline) {
    ref.set({ role: "astrologer", busy: false });
    ref.onDisconnect().remove();
  } else {
    ref.remove();
  }
}

/* ================= SHOW ONLINE ASTROLOGERS ================= */
db.ref("presence").on("value", snap => {
  astrologerList.innerHTML = "";
  snap.forEach(c => {
    if (c.val().role === "astrologer") {
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <strong>${c.key}</strong> ${c.val().busy ? "(Busy)" : ""}<br>
        <button ${c.key === userId ? "disabled" : ""} onclick="requestChat('${c.key}')">
          Request Chat
        </button>`;
      astrologerList.appendChild(card);
    }
  });
});

/* ================= CLIENT â†’ REQUEST ================= */
function requestChat(astrologerId) {
  if (astrologerId === userId) return alert("You cannot chat with yourself");

  db.ref("presence/" + astrologerId).once("value", snap => {
    if (!snap.exists() || snap.val().busy) {
      alert("Astrologer unavailable");
      return;
    }
    db.ref("queue/" + astrologerId).push({
      client: userId,
      time: Date.now()
    });
    if (Notification.permission === "granted") {
      new Notification("Chat request sent");
    }
  });
}

/* ================= ASTROLOGER QUEUE (ALWAYS LISTENING) ================= */
db.ref("queue/" + userId).on("value", snap => {
  requestList.innerHTML = "";
  snap.forEach(r => {
    if (!r.val().chatStarted) {
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        Request from ${r.val().client}<br>
        <button onclick="acceptQueue('${r.key}','${r.val().client}')">Accept</button>
        <button onclick="rejectQueue('${r.key}')">Reject</button>`;
      requestList.appendChild(card);
    }
  });
});

/* ================= ACCEPT ================= */
function acceptQueue(queueKey, clientId) {
  if (chatId) return alert("Finish current chat first");

  chatId = db.ref().push().key;
  currentPartner = clientId;

  db.ref("presence/" + userId).update({ busy: true });

  db.ref("chats/" + chatId).set({
    active: true,
    participants: {
      [userId]: true,
      [clientId]: true
    }
  });

  db.ref("queue/" + userId + "/" + queueKey).remove();
  db.ref("currentChat/" + userId).set(chatId);
  db.ref("currentChat/" + clientId).set(chatId);
}

/* ================= REJECT ================= */
function rejectQueue(queueKey) {
  db.ref("queue/" + userId + "/" + queueKey).remove();
}

/* ================= BOTH SIDES CHAT OPEN ================= */
db.ref("currentChat/" + userId).on("value", snap => {
  if (snap.exists()) {
    chatId = snap.val();
    openChat(chatId);
  }
});

/* ================= CHAT ================= */
function openChat(id) {
  chatView.classList.remove("hidden");
  messages.innerHTML = "";

  if (chatListener) chatListener.off();

  chatListener = db.ref("chats/" + id + "/messages");
  chatListener.on("child_added", snap => {
    const div = document.createElement("div");
    div.textContent = snap.val().from + ": " + snap.val().text;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
  });
}

function sendMessage() {
  if (!chatId) return;
  const text = msgInput.value.trim();
  if (!text) return;
  db.ref("chats/" + chatId + "/messages").push({
    from: userId,
    text
  });
  msgInput.value = "";
}

/* ================= EXIT CHAT ================= */
function exitChat() {
  if (!chatId) return;

  db.ref("chats/" + chatId).remove();
  db.ref("currentChat/" + userId).remove();
  if (currentPartner) db.ref("currentChat/" + currentPartner).remove();
  if (role === "astrologer") db.ref("presence/" + userId).update({ busy: false });

  chatId = null;
  currentPartner = null;
  chatView.classList.add("hidden");
}
</script>


</body>
</html>
