<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AstroLab</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
* { box-sizing: border-box; transition: all 0.3s ease; }
body {
  margin: 0;
  font-family: 'Segoe UI', Arial, sans-serif;
  background: #f4f6f8;
  display: flex;
  height: 100vh;
  overflow: hidden;
}
.sidebar {
  width: 260px;
  background: #fff;
  border-right: 1px solid #ddd;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 15px;
  box-shadow: 2px 0 6px rgba(0,0,0,0.05);
}
.sidebar button {
  padding: 12px;
  border: none;
  background: #007bff;
  color: white;
  cursor: pointer;
  border-radius: 8px;
  font-weight: bold;
}
.sidebar button:hover { background: #0056b3; }

.main { flex: 1; padding: 25px; overflow-y: auto; position: relative; }

.card {
  background: #fff;
  border-radius: 10px;
  padding: 15px;
  margin-bottom: 15px;
  box-shadow: 0 3px 10px rgba(0,0,0,0.08);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.12); }

.chat-box {
  height: 350px;
  border: 1px solid #ddd;
  background: #fff;
  padding: 10px;
  overflow-y: auto;
  margin-bottom: 10px;
  border-radius: 8px;
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.hidden { display: none; }
input, button, textarea { 
  padding: 10px; 
  margin-top: 5px; 
  width: 100%; 
  border-radius: 6px; 
  border: 1px solid #ccc;
}
button { cursor: pointer; }
#error { color: red; font-weight: bold; }

.message {
  max-width: 70%;
  padding: 8px 12px;
  border-radius: 12px;
  opacity: 0;
  animation: fadeIn 0.3s forwards;
  word-wrap: break-word;
}
.message.self { background: #007bff; color: white; margin-left: auto; }
.message.partner { background: #e2e6ea; color: black; margin-right: auto; }

@keyframes fadeIn {
  to { opacity: 1; }
}
.card button { transition: background 0.2s ease; }
.card button:hover { background: #0056b3; }
</style>
</head>

<body>

<div class="sidebar">
  <h2>AstroLab</h2>
  <button onclick="switchRole('client')">Client</button>
  <button onclick="switchRole('astrologer')">Astrologer</button>
</div>

<div class="main">

  <!-- AUTH -->
  <div id="authCard" class="card">
    <h3>Login / Signup</h3>
    <input id="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
    <input id="username" placeholder="Username (unique)">
    <button onclick="signup()">Signup</button>
    <button onclick="login()">Login</button>
    <button onclick="googleLogin()">Sign in with Google</button>
    <p id="error"></p>
  </div>

  <!-- PROFILE -->
  <div id="profileCard" class="card hidden">
    <h3>Profile Settings</h3>
    <input id="p_username" placeholder="Username">
    <input id="p_speciality" placeholder="Speciality">
    <textarea id="p_desc" placeholder="Description"></textarea>
    <button onclick="saveProfile()">Save</button>
    <button onclick="logout()">Logout</button>
  </div>

  <!-- CLIENT VIEW -->
  <div id="clientView" class="hidden">
    <h3>Online Astrologers</h3>
    <div id="astrologerList"></div>
  </div>

  <!-- ASTROLOGER VIEW -->
  <div id="astrologerView" class="hidden">
    <h3>Astrologer Dashboard</h3>
    <label><input type="checkbox" onchange="toggleOnline(this.checked)"> Go Online</label>
    <h4>Chat Queue</h4>
    <div id="queueList"></div>
  </div>

  <!-- CHAT VIEW -->
  <div id="chatView" class="hidden">
    <h3 id="chatTitle">Live Chat</h3>
    <div class="chat-box" id="messages"></div>
    <input id="msgInput" placeholder="Type message..." />
    <button onclick="sendMessage()">Send</button>
    <button onclick="exitChat()">Exit Chat</button>
  </div>

</div>

<script>
/* ================= FIREBASE ================= */
const firebaseConfig = {
  apiKey: "AIzaSyALzPqt1EdWG9cWeFf2gZP8Z470D0puPds",
  authDomain: "astrolab-b8956.firebaseapp.com",
  databaseURL: "https://astrolab-b8956-default-rtdb.firebaseio.com",
  projectId: "astrolab-b8956",
  storageBucket: "astrolab-b8956.appspot.com",
  messagingSenderId: "000000000000",
  appId: "1:000000000000:web:000000000000"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

/* ================= STATE ================= */
let userId=null, role="client", chatId=null, partnerId=null, chatRef=null, queueRef=null;
let userCache = {};
const authCard = document.getElementById("authCard");
const profileCard = document.getElementById("profileCard");
const clientView = document.getElementById("clientView");
const astrologerView = document.getElementById("astrologerView");
const chatView = document.getElementById("chatView");
const error = document.getElementById("error");
const astrologerList = document.getElementById("astrologerList");
const queueList = document.getElementById("queueList");
const messagesDiv = document.getElementById("messages");
const msgInput = document.getElementById("msgInput");
const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const usernameInput = document.getElementById("username");
const p_username = document.getElementById("p_username");
const p_speciality = document.getElementById("p_speciality");
const p_desc = document.getElementById("p_desc");
const chatTitle = document.getElementById("chatTitle");

/* ================= AUTH ================= */
auth.onAuthStateChanged(user=>{
  if(user){
    userId=user.uid;
    authCard.classList.add("hidden");
    profileCard.classList.remove("hidden");
    clientView.classList.remove("hidden");
    loadProfile();
    loadUserCache();
    removeStaleChat();
  }else{
    userId=null;
    authCard.classList.remove("hidden");
    profileCard.classList.add("hidden");
    clientView.classList.add("hidden");
    astrologerView.classList.add("hidden");
    chatView.classList.add("hidden");
  }
});
function showError(msg){ error.textContent=msg; }

/* ================= SIGNUP/LOGIN ================= */
function signup(){
  const e=emailInput.value, p=passwordInput.value, u=usernameInput.value.trim().toLowerCase();
  if(!u) return showError("Username required");
  db.ref("presence").once("value").then(snap=>{
    let taken=false;
    snap.forEach(c=>{ if(c.val().username===u) taken=true; });
    if(taken) return showError("Username already in use");
    auth.createUserWithEmailAndPassword(e,p).then(res=>{
      userId=res.user.uid;
      db.ref("presence/"+userId).set({ username:u, speciality:"", description:"", role:"user", busy:false });
    }).catch(err=>showError(err.message));
  });
}
function login(){ auth.signInWithEmailAndPassword(emailInput.value,passwordInput.value).catch(err=>showError(err.message)); }
function googleLogin(){
  const provider=new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider).then(res=>{
    userId=res.user.uid;
    db.ref("presence/"+userId).once("value").then(snap=>{
      if(!snap.exists()) db.ref("presence/"+userId).set({ username:"user_"+userId.slice(0,6), speciality:"", description:"", role:"user", busy:false });
    });
  }).catch(err=>showError(err.message));
}

/* ================= PROFILE ================= */
function loadProfile(){ db.ref("presence/"+userId).once("value").then(snap=>{
  const d=snap.val(); if(!d) return;
  p_username.value=d.username||"";
  p_speciality.value=d.speciality||"";
  p_desc.value=d.description||"";
}); }
function saveProfile(){
  const uname=p_username.value.trim().toLowerCase();
  if(!uname) return showError("Username required");
  db.ref("presence").once("value").then(snap=>{
    let taken=false;
    snap.forEach(c=>{ if(c.key!==userId && c.val().username===uname) taken=true; });
    if(taken) return showError("Username already in use");
    db.ref("presence/"+userId).update({ username:uname, speciality:p_speciality.value, description:p_desc.value });
    alert("Profile saved");
  });
}
function logout(){ auth.signOut(); }

/* ================= ROLE SWITCH ================= */
function switchRole(r){
  role=r;
  clientView.classList.toggle("hidden", r!=="client");
  astrologerView.classList.toggle("hidden", r!=="astrologer");
  chatView.classList.add("hidden");
}

/* ================= ONLINE TOGGLE ================= */
function toggleOnline(isOnline){
  const ref=db.ref("presence/"+userId);
  if(isOnline){
    ref.update({ role:"astrologer", busy:false });
    ref.onDisconnect().update({ busy:false });
    startQueueListener();
  }else{
    stopQueueListener();
    ref.update({ role:"user", busy:false });
  }
}

/* ================= QUEUE ================= */
function startQueueListener(){
  queueList.innerHTML="";
  queueRef=db.ref("requests/"+userId);
  queueRef.off();
  queueRef.on("child_added", snap=>{
    const data=snap.val();
    const clientName = userCache[data.client]||data.client;
    const div=document.createElement("div");
    div.className="card";
    div.innerHTML=`Request from <strong>${clientName}</strong><br>
      <button onclick="acceptChat('${snap.key}','${data.client}')">Accept</button>`;
    queueList.appendChild(div);
  });
}
function stopQueueListener(){ if(queueRef) queueRef.off(); queueList.innerHTML=""; }

/* ================= ASTROLOGER LIST ================= */
db.ref("presence").on("value", snap=>{
  astrologerList.innerHTML="";
  snap.forEach(child=>{
    const data=child.val();
    if(data.role==="astrologer"){
      const uname=data.username||child.key;
      const div=document.createElement("div");
      div.className="card";
      div.innerHTML=`<strong>${uname}</strong> ${data.busy?"(Busy)":"(Online)"}<br>
        <button onclick="requestChat('${child.key}')" ${data.busy?"disabled":""}>Request Chat</button>`;
      astrologerList.appendChild(div);
    }
    userCache[child.key]=data.username;
  });
});

/* ================= REQUEST CHAT ================= */
function requestChat(astrologerId){
  db.ref("requests/"+astrologerId).push({ client:userId, time:Date.now() });
  alert("Chat request sent");
}

/* ================= ACCEPT CHAT ================= */
function acceptChat(queueKey, clientId){
  chatId=db.ref().push().key;
  partnerId=clientId;
  db.ref("presence/"+userId).update({ busy:true });
  db.ref("requests/"+userId+"/"+queueKey).remove();
  db.ref("currentChat/"+userId).set({ chatId, partner:clientId });
  db.ref("currentChat/"+clientId).set({ chatId, partner:userId });
}

/* ================= CHAT ASSIGN ================= */
db.ref("currentChat/"+userId).on("value", snap=>{
  if(snap.exists()) openChat(snap.val().chatId, snap.val().partner);
  else closeChatUI();
});

/* ================= OPEN CHAT ================= */
function openChat(id, partner){
  chatId=id;
  partnerId=partner;
  chatView.classList.remove("hidden");
  messagesDiv.innerHTML="";
  const partnerName=userCache[partner]||partner;
  const selfName=userCache[userId]||userId;
  chatTitle.textContent=`Chat: ${selfName} â†” ${partnerName}`;
  if(chatRef) chatRef.off();
  chatRef=db.ref("chats/"+id+"/messages");
  chatRef.on("child_added", snap=>{
    const msg=snap.val();
    const div=document.createElement("div");
    div.className="message "+(msg.from===userId?"self":"partner");
    const name=userCache[msg.from]||msg.from;
    div.textContent=`${name}: ${msg.text}`;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop=messagesDiv.scrollHeight;
  });
}

/* ================= SEND MESSAGE ================= */
function sendMessage(){
  if(!chatId) return;
  const text=msgInput.value.trim();
  if(!text) return;
  db.ref("chats/"+chatId+"/messages").push({ from:userId, text, time:Date.now() });
  msgInput.value="";
}

/* ================= EXIT CHAT ================= */
function exitChat(){
  if(!chatId) return;
  if(partnerId){
    db.ref("currentChat/"+partnerId).remove();
    db.ref("presence/"+partnerId).update({ busy:false });
  }
  db.ref("currentChat/"+userId).remove();
  db.ref("presence/"+userId).update({ busy:false });
  closeChatUI();
}
function closeChatUI(){
  chatId=null; partnerId=null;
  chatView.classList.add("hidden");
  if(chatRef) chatRef.off();
}

/* ================= REMOVE STALE CHAT ================= */
function removeStaleChat(){
  db.ref("currentChat/"+userId).once("value").then(snap=>{
    if(snap.exists()){
      const partner=snap.val().partner;
      db.ref("presence/"+partner).once("value").then(pSnap=>{
        if(!pSnap.exists() || pSnap.val().role!=="astrologer") db.ref("currentChat/"+userId).remove();
      });
    }
  });
}

/* ================= LOAD USERNAMES CACHE ================= */
function loadUserCache(){
  db.ref("presence").once("value").then(snap=>{
    snap.forEach(child=>{ userCache[child.key]=child.val().username; });
  });
}
</script>

</body>
</html>
