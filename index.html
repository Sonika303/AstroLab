<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AstroLab</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
:root {
  --white-0: #ffffff;
  --white-1: #f9fafb;
  --white-2: #f3f4f6;
  --white-3: #e5e7eb;

  --primary: #2563eb;
  --primary-dark: #1e40af;
  --primary-soft: #dbeafe;

  --text: #0f172a;
  --muted: #6b7280;

  --border: rgba(15,23,42,.08);
  --card: #ffffff;

  --shadow-soft: 0 20px 40px rgba(15,23,42,.08);
  --shadow-hover: 0 30px 60px rgba(15,23,42,.12);
}

* {
  box-sizing: border-box;
  transition:
    background-color .25s ease,
    color .25s ease,
    box-shadow .25s ease,
    transform .25s ease;
}

body {
  margin: 0;
  font-family: Inter, Arial, sans-serif;
  background: linear-gradient(180deg, #ffffff, #f8fafc);
  display: flex;
  perspective: 1200px;
  height: 100vh;
  overflow: hidden;
  color: var(--text);
}

/* ---------- SIDEBAR ---------- */
.sidebar {
  width: 240px;
  background: var(--card);
  border-right: 1px solid var(--border);
  padding: 18px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  box-shadow: 6px 0 24px rgba(15,23,42,.04);
  animation: slideInLeft .5s ease;
}

.sidebar h2 {
  margin: 0 0 10px;
}

.sidebar button {
  padding: 12px;
  border: none;
  background: var(--primary);
  color: white;
  cursor: pointer;
  border-radius: 14px;
  font-weight: 500;
  transition: transform .15s ease, box-shadow .15s ease, background .2s;
}

.sidebar button:hover {
  background: var(--primary-dark);
  transform: translateY(-1px);
  box-shadow: 0 6px 14px rgba(79,70,229,.25);
}

.sidebar button:active {
  transform: scale(.97);
}

/* ---------- SETTINGS PANEL ---------- */
.settings {
  position: fixed;
  right: -320px;
  top: 0;
  width: 320px;
  height: 100%;
  background: var(--card);
  border-left: 1px solid var(--border);
  padding: 18px;
  z-index: 1000;
  transition: right .35s cubic-bezier(.4,0,.2,1), opacity .3s;
  overflow-y: auto;
  opacity: 0;
}

.settings.open {
  right: 0;
  opacity: 1;
}

/* ---------- MAIN ---------- */
.main {
  flex: 1;
  padding: 24px;
  overflow-y: auto;
  animation: fadeIn .4s ease;
}

/* ---------- CARDS ---------- */
.card {
  background: var(--card);
  border-radius: 20px;
  padding: 22px;
  margin-bottom: 18px;
  border: 1px solid var(--border);
  box-shadow: var(--shadow-soft);
  animation: cardIn .35s ease both;
}

.card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-hover);
}

/* ---------- AVATAR ---------- */
.avatar {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  object-fit: cover;
  margin-bottom: 10px;
  box-shadow: 0 6px 18px rgba(0,0,0,.15);
}
.avatar {
  transition: transform .3s ease, box-shadow .3s ease;
}

.avatar:hover {
  transform: scale(1.05);
  box-shadow: 0 14px 32px rgba(0,0,0,.18);
}

/* ---------- INPUTS ---------- */
input, textarea {
  padding: 14px;
  margin-top: 6px;
  width: 100%;
  border-radius: 14px;
  border: 1px solid var(--border);
  background: var(--white-1);
  font-size: 14px;
}

input:focus, textarea:focus {
  outline: none;
  background: var(--white-0);
  border-color: var(--primary);
  box-shadow: 0 0 0 4px rgba(37,99,235,.15);
}

button {
  padding: 13px;
  width: 100%;
  border-radius: 16px;
  border: none;
  background: linear-gradient(180deg, var(--primary), var(--primary-dark));
  color: #ffffff;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 14px 28px rgba(37,99,235,.35);
}

button:hover {
  transform: translateY(-2px);
  box-shadow: 0 20px 40px rgba(37,99,235,.45);
}

button:active {
  transform: scale(.97);
}

button:disabled {
  opacity: .5;
  cursor: not-allowed;
}

input:focus, textarea:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(79,70,229,.15);
}

/* ---------- CHAT ---------- */
.chat-box {
  height: 320px;
  border: 1px solid var(--border);
  background: #ffffff;
  padding: 14px;
  border-radius: 16px;
  box-shadow: inset 0 1px 2px rgba(15,23,42,.04);
}

.message {
  margin-bottom: 10px;
  padding: 12px 16px;
  border-radius: 18px;
  background: var(--white-2);
  max-width: 72%;
  box-shadow: 0 8px 20px rgba(15,23,42,.08);
  animation: msgIn .25s ease;
}

.message.self {
  background: linear-gradient(180deg, var(--primary), var(--primary-dark));
  color: white;
  margin-left: auto;
}

.stars i{
  font-size:18px;
  color:#d1d5db;
  cursor:pointer;
  margin-right:4px;
}
.stars i.active{ color:#facc15; }

.review-box{
  margin-top:10px;
}
.review{
  font-size:13px;
  border-top:1px solid var(--border);
  padding-top:6px;
  margin-top:6px;
}
  /* ---------- REVIEW SIDE PANEL ---------- */
.review-panel {
  position: relative;
  margin-top: 12px;
  border: 1px solid var(--border);
  border-radius: 14px;
  background: #f9fafb;
  padding: 10px;
}

.review-stats {
  font-size: 12px;
  color: var(--muted);
  margin-bottom: 6px;
}

.review-stats div {
  display: flex;
  justify-content: space-between;
}

.review-scroll {
  max-height: 220px;
  overflow-y: auto;
  padding-right: 4px;
}

.review-item {
  border-top: 1px solid var(--border);
  padding: 6px 0;
  font-size: 13px;
}

.review-user {
  font-weight: 600;
  font-size: 12px;
}

.review-stars {
  color: #facc15;
  font-size: 13px;
}

.review-delete {
  background: #dc2626;
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 4px 6px;
  font-size: 11px;
  cursor: pointer;
  margin-top: 4px;
}

/* ---------- UTIL ---------- */
.hidden { display: none; }
#error { color: #dc2626; font-weight: 500; }

/* ---------- ANIMATIONS ---------- */
@keyframes fadeIn {
  from { opacity: 0 }
  to { opacity: 1 }
}

@keyframes slideInLeft {
  from { transform: translateX(-20px); opacity: 0 }
  to { transform: translateX(0); opacity: 1 }
}

@keyframes cardIn {
  from { transform: translateY(12px); opacity: 0 }
  to { transform: translateY(0); opacity: 1 }
}

@keyframes msgIn {
  from { transform: translateY(6px); opacity: 0 }
  to { transform: translateY(0); opacity: 1 }
}

</style>
</head>
<body>

<div id="settingsPanel" class="settings">
  <h3>Account Settings</h3>
  <img id="avatarPreview" class="avatar" src="" alt="Avatar">
  <input type="file" id="avatarInput" accept="image/*">
  <input id="s_name" placeholder="Display Name">
  <input id="s_speciality" placeholder="Speciality">
  <input id="s_desc" placeholder="Description"></input>
  <hr>

<p><strong>Login Method:</strong> <span id="loginProvider">‚Äî</span></p>
<p><strong>Linked Email:</strong> <span id="linkedEmail">‚Äî</span></p>
  <button id="linkGoogleBtn" onclick="linkGoogle()">
  Link Google Account
</button>

<button id="unlinkGoogleBtn" onclick="unlinkGoogle()" style="background:#dc2626">
  Unlink Google Account
</button>

<input id="newEmail" placeholder="New Email">
<button onclick="changeEmail()">Change Email</button>

<!-- üî• NEW PASSWORD CHANGE FIELDS -->
<input id="currentPassword" type="password" placeholder="Current Password">
<input id="newPassword" type="password" placeholder="New Password">
<button onclick="changePassword()">Change Password</button>

<button onclick="saveSettings()">Save</button>
</div>

<div class="sidebar">
  <h2>AstroLab</h2>
  <div id="secretReset" style="height:20px; opacity:0;" onclick="secretTap()"></div>
  <button onclick="switchRole('client')">
  <i class="fa-solid fa-user"></i> Client
</button>
  <button onclick="switchRole('astrologer')">
  <i class="fa-solid fa-star"></i> Astrologer
</button>
  <button onclick="toggleSettings()">
  <i class="fa-solid fa-gear"></i> Settings
</button>
<button onclick="logout()">
  <i class="fa-solid fa-right-from-bracket"></i> Logout
</button>
</div>

<div class="main">

  <!-- AUTH -->
  <div id="authCard" class="card">
    <h3>Login / Signup</h3>
    <input id="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
<label>
  <input type="checkbox" onclick="password.type=this.checked?'text':'password'">
  Show Password
</label>
    <input id="username" placeholder="Username (unique)">
    <button type="button" onclick="signup()">Signup</button>
    <button type="button" onclick="login()">Login</button>
    <button type="button" onclick="forgotPassword()" style="background:#64748b">
  Forgot Password
</button>
    <button type="button" onclick="googleLogin()">Sign in with Google</button>
    <p id="error"></p>
  </div>

  <!-- CLIENT VIEW -->
  <div id="clientView" class="hidden">
    <h3>Online Astrologers</h3>
    <div id="astrologerList"></div>
  </div>

  <p><strong>Your Credits:</strong> <span id="creditBalance">0</span></p>

<div class="card">
  <h3>Buy Credits</h3>

  <button onclick="buyCredits(49)">
    üí† ‚Çπ49 ‚Äî Get 50 Credits
  </button>

  <button onclick="buyCredits(99)">
    ‚≠ê ‚Çπ99 ‚Äî Get 100 Credits
  </button>

  <button onclick="buyCredits(249)">
    üî• ‚Çπ249 ‚Äî Get 250 Credits 
  </button>

  <small style="color:#64748b;">
    Credits will be added within 24 hours after payment.
  </small>
</div>

<hr>

  <!-- ASTROLOGER VIEW -->
<div id="astrologerView" class="hidden">
  <p>Your Rate: <strong><span id="astroRate">0</span></strong> credits/min</p>

  <!-- üî• EDIT RATE -->
  <input id="rateInput" type="number" min="1" placeholder="Set credits per minute">
  <button onclick="updateRate()">Update Rate</button>

  <h3>Astrologer Dashboard</h3>
  <p>
  <strong>Today's Earnings:</strong>
  <span id="todayEarnings">0</span> credits
</p>

    <label>
      <input type="checkbox" onchange="toggleOnline(this.checked)"> Go Online
    </label>
    <h4>Chat Queue</h4>
    <div id="queueList"></div>
  </div>

  <!-- CHAT VIEW -->
  <div id="chatView" class="hidden">
<h3 style="display:flex;justify-content:space-between;align-items:center;">
  Live Chat
  <span id="chatTimer" style="font-size:12px;color:#6b7280;">00:00</span>
</h3>
  <div class="chat-box" id="messages"></div>
    <input id="msgInput" placeholder="Type message..." />
    <br>
    <button onclick="sendMessage()">
  <i class="fa-solid fa-paper-plane"></i> Send
</button>
    <button onclick="exitChat()">
  <i class="fa-solid fa-xmark"></i> End Chat
</button>
  </div>

</div>

<script>
/* ================= FIREBASE CONFIG ================= */
const firebaseConfig = {
  apiKey: "AIzaSyALzPqt1EdWG9cWeFf2gZP8Z470D0puPds",
  authDomain: "astrolab-b8956.firebaseapp.com",
  databaseURL: "https://astrolab-b8956-default-rtdb.firebaseio.com",
  projectId: "astrolab-b8956",
  storageBucket: "astrolab-b8956.appspot.com",
  messagingSenderId: "83087467626",
  appId: "1:83087467626:web:66f6b648562f5939425613"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();
const storage = firebase.storage();
const connectedRef = db.ref(".info/connected");
connectedRef.on("value", snap=>{
  if(chatId){
  db.ref("chats/"+chatId).remove();
}
  if(snap.val() === false && userId){
    db.ref("currentChat/" + userId).remove();
  }
});

/* ================= STATE ================= */
let userId = null;
let role = "client";
const ROLE_KEY = "astrolab_role";
let chatId = null;
let partnerId = null;
let chatRef = null;
let queueRef = null;
let userCache = {}; // cache usernames
let creditInterval = null;
let chatStartTime = null;
let chatTimerInterval = null;

/* ================= ELEMENTS ================= */
const authCard = document.getElementById("authCard");
const clientView = document.getElementById("clientView");
const astrologerView = document.getElementById("astrologerView");
const chatView = document.getElementById("chatView");
const error = document.getElementById("error");
const astrologerList = document.getElementById("astrologerList");
const queueList = document.getElementById("queueList");
const messagesDiv = document.getElementById("messages");
const msgInput = document.getElementById("msgInput");
const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const usernameInput = document.getElementById("username");
const avatarInput = document.getElementById("avatarInput");
const avatarPreview = document.getElementById("avatarPreview");
const s_name = document.getElementById("s_name");
const s_speciality = document.getElementById("s_speciality");
const s_desc = document.getElementById("s_desc");

/* ================= AUTH STATE ================= */
auth.onAuthStateChanged(user => {
  if(user){
    setTimeout(() => {
  const providerSpan = document.getElementById("loginProvider");
  const emailSpan = document.getElementById("linkedEmail");

  if (providerSpan && emailSpan) {
    const providers = user.providerData.map(p => p.providerId);
    const linkBtn = document.getElementById("linkGoogleBtn");
const unlinkBtn = document.getElementById("unlinkGoogleBtn");

if(providers.includes("google.com")){
  linkBtn.style.display = "none";
  unlinkBtn.style.display = "block";
} else {
  linkBtn.style.display = "block";
  unlinkBtn.style.display = "none";
}

    providerSpan.textContent =
      providers.includes("google.com")
        ? "Google"
        : "Email & Password";

    emailSpan.textContent = user.email || "Not linked";
  }
}, 500);
    userId = user.uid;

    authCard.classList.add("hidden");
    clientView.classList.remove("hidden");
    astrologerView.classList.add("hidden");
    chatView.classList.add("hidden");
    astrologerView.classList.add("hidden");
    chatView.classList.add("hidden");

    loadProfile();
    const savedRole = localStorage.getItem(ROLE_KEY);
if(savedRole){
  switchRole(savedRole);
}
    const wasOnline = localStorage.getItem(ONLINE_KEY);
if(savedRole === "astrologer" && wasOnline === "1"){
  toggleOnline(true);
  document.querySelector("#astrologerView input[type=checkbox]").checked = true;
}
    loadUserCache();
    watchCredits();
    watchAstroRate();

 // üî• CHAT OPEN + CHAT END LISTENER
db.ref("currentChat/" + userId).on("value", snap => {
  if (!snap.exists()) return;

  const chatId = snap.val();

  db.ref("chats/" + chatId + "/meta").once("value").then(metaSnap=>{
    const meta = metaSnap.val();

    if(!meta || meta.active !== true){
      db.ref("currentChat/" + userId).remove();
      return;
    }

    openChat(chatId);
  });
});
  c                                                                                                                                                                            
} else {
  userId = null;
  chatId = null;
  partnerId = null;

  authCard.classList.remove("hidden");
  clientView.classList.add("hidden");
  astrologerView.classList.add("hidden");
  chatView.classList.add("hidden");

  document.getElementById("settingsPanel").classList.remove("open");
}

});


/* ================= ERROR ================= */
function showError(msg){ error.textContent = msg; }
function toggleSettings(){
  if(!userId){
    alert("Please sign in to open settings");
    return;
  }
  document.getElementById("settingsPanel").classList.toggle("open");
}
  let tapCount = 0;
function secretTap(){
  tapCount++;
  if(tapCount >= 5){
    tapCount = 0;
    resetEveryone();
  }
}



/* ================= SIGNUP ================= */
function signup(){
  const e = emailInput.value.trim();
  const p = passwordInput.value.trim();
  const u = usernameInput.value.trim().toLowerCase();

  if(!e || !p || !u){
    showError("Email, password and username are required");
    return;
  }

  if(p.length < 6){
    showError("Password must be at least 6 characters");
    return;
  }

  db.ref("presence").once("value").then(snap=>{
    let taken = false;
    snap.forEach(c=>{
      if(c.val().username === u) taken = true;
    });

    if(taken){
      showError("Username already taken");
      return;
    }

    auth.createUserWithEmailAndPassword(e,p)
      .then(res=>{
        userId = res.user.uid;
        return db.ref("presence/"+userId).set({
          username: u,
          speciality: "",
          description: "",
          avatar: "",
          role: "user",
          busy: false,
          online: false,
          lastSeen: Date.now(),
          credits: 20,
          ratePerMinute: 2,
          firstChatUsed: false
        });
      })
      .catch(err=>showError(err.message));
  });
}

/* ================= LOGIN ================= */
function login(){
  const e = emailInput.value.trim();
  const p = passwordInput.value.trim();

  if(!e || !p){
    showError("Email and password required");
    return;
  }

  auth.signInWithEmailAndPassword(e,p)
    .catch(err=>showError(err.message));
}

/* ================= GOOGLE LOGIN ================= */
function googleLogin(){
  const provider = new firebase.auth.GoogleAuthProvider();

  auth.signInWithPopup(provider)
    .then(res=>{
      userId = res.user.uid;

      const ref = db.ref("presence/" + userId);
      ref.once("value").then(snap=>{
        if(!snap.exists()){
          ref.set({
            username: "user_" + userId.slice(0,6),
            speciality: "",
            description: "",
            avatar: "",
            role: "user",
            busy: false,
            online: false,
            lastSeen: Date.now(),
            credits: 20,
            ratePerMinute: 2,
            firstChatUsed: false
          });
        }
      });
    })
    .catch(err=>{
      console.error(err);
      showError(err.message);
    });
}

/* ================= LOAD PROFILE ================= */
function loadProfile(){
  if(!userId) return;

  db.ref("presence/"+userId).once("value").then(snap=>{
    const d = snap.val();
    if(!d) return;

    s_name.value = d.username || "";
    s_speciality.value = d.speciality || "";
    s_desc.value = d.description || "";

    // üî• force reload avatar
    avatarPreview.src = d.avatar 
      ? d.avatar + "&r=" + Date.now()
      : "https://via.placeholder.com/80";
  });
}

/* ================= LOGOUT ================= */
function logout(){
  clearMyRequests();
  auth.signOut();
}
function saveSettings(){
  if(!userId){
    alert("Please sign in to save settings");
    return;
  }

  const file = avatarInput.files[0];
  const name = s_name.value.trim().toLowerCase();
  if(!name) return showError("Name required");

  // base profile data
  const baseData = {
    username: name,
    speciality: s_speciality.value,
    description: s_desc.value
  };

  // NO IMAGE ‚Üí just save text
  if(!file){
    db.ref("presence/"+userId).update(baseData).then(()=>{
      alert("Settings saved");
    });
    return;
  }

  // IMAGE UPLOAD
  const ref = storage.ref(`avatars/${userId}.jpg`);
  ref.put(file)
    .then(()=>ref.getDownloadURL())
    .then(url=>{
      // üî• cache-busting
      const bustedUrl = url + "?v=" + Date.now();

      baseData.avatar = bustedUrl;

      return db.ref("presence/"+userId).update(baseData).then(()=>{
        avatarPreview.src = bustedUrl;
        avatarInput.value = "";
        alert("Settings saved");
      });
    })
    .catch(err=>{
      console.error(err);
      showError("Image upload failed");
    });
}

function updateProfile(name, avatar){
  const data = {
    username: name,
    speciality: s_speciality.value,
    description: s_desc.value
  };
  if(avatar) data.avatar = avatar;
  db.ref("presence/"+userId).update(data);
}


/* ================= ROLE SWITCH ================= */
function switchRole(r){
  if(!userId){
    alert("Please sign in first");
    return;
  }

  role = r;
  localStorage.setItem(ROLE_KEY, r);

  clientView.classList.toggle("hidden", r !== "client");
  astrologerView.classList.toggle("hidden", r !== "astrologer");
  chatView.classList.add("hidden");

  // üî• START EARNINGS LISTENER WHEN ASTROLOGER VIEW OPENS
  if(r === "astrologer"){
    watchTodayEarnings();
  } else {
    if(earningsRef){
      earningsRef.off();
      earningsRef = null;
    }
  }
}

/* ================= ASTROLOGER ONLINE ================= */
function toggleOnline(isOnline){
  const ref = db.ref("presence/"+userId);

  localStorage.setItem(ONLINE_KEY, isOnline ? "1" : "0");

  if(isOnline){
    clearMyRequests();
    ref.update({
      role: "astrologer",
      online: true,
      busy: false,
      lastSeen: Date.now()
    });

    ref.onDisconnect().update({
      online: false,
      busy: false,
      lastSeen: Date.now()
    });

    startQueueListener();
  } else {
    clearMyRequests();
    stopQueueListener();
    ref.update({
      online: false,
      busy: false,
      lastSeen: Date.now()
    });
  }
}

/* ================= QUEUE LISTENER ================= */
function startQueueListener(){
  queueList.innerHTML="";
  queueRef = db.ref("requests/"+userId);
  queueRef.off();
 queueRef.on("child_added", snap=>{
  const data = snap.val();
  const clientName = userCache[data.client] || data.client;

  const div = document.createElement("div");
  div.className = "card";
  div.id = "req_" + snap.key;

  div.innerHTML = `
    Request from <strong>${clientName}</strong><br>
    <button onclick="acceptChat('${snap.key}','${data.client}')">Accept</button>
  `;

  queueList.appendChild(div);
});

queueRef.on("child_removed", snap=>{
  const el = document.getElementById("req_" + snap.key);
  if(el) el.remove();
});

}
function stopQueueListener(){ if(queueRef) queueRef.off(); queueList.innerHTML=""; }

/* ================= CLIENT VIEW ================= */
db.ref("presence").on("value", snap=>{
  astrologerList.innerHTML="";
  snap.forEach(child=>{
    const data = child.val();
if(data.role === "astrologer" && data.online === true){
      const uname = data.username || child.key;
      const div=document.createElement("div");
      div.className="card";
div.innerHTML = `
  <img src="${data.avatar || 'https://via.placeholder.com/80'}" class="avatar">
  <strong>${uname}</strong>
  <div class="stars" id="stars_${child.key}"></div>

  <small>${data.speciality || "Astrology"}</small><br>
  <small><strong>${data.ratePerMinute}</strong> credits / min</small>

  <p>${data.description || ""}</p>

  <div class="review-box">
    <textarea id="reviewText_${child.key}" placeholder="Write a review (optional)"></textarea>
    <button onclick="submitReview('${child.key}')">Submit Review</button>
  </div>

  <div class="review-panel">
  <div class="review-stats" id="reviewStats_${child.key}"></div>
  <div class="review-scroll" id="reviews_${child.key}"></div>
</div>

  <button onclick="requestChat('${child.key}', ${data.ratePerMinute || 0})"
    ${(!data.online || data.busy) ? "disabled" : ""}>
    ${data.busy ? "Busy" : "Request Chat"}
  </button>
`;
      astrologerList.appendChild(div);
    }
    // cache usernames
    renderStars(child.key);
loadReviews(child.key);
    userCache[child.key] = data.username;
  });
});

/* ================= SEND REQUEST ================= */
function requestChat(astrologerId, rate){
  if(!userId){
    alert("Please sign in to request a chat");
    return;
  }

  db.ref("presence/"+userId+"/credits").once("value").then(snap=>{
    const credits = snap.val() || 0;

    if(credits < rate){
      alert("Not enough credits for this astrologer");
      return;
    }

    db.ref("requests/"+astrologerId).push({
      client: userId,
      time: Date.now()
    });

    alert("Chat request sent");
  });
}

/* ================= ACCEPT CHAT ================= */
function acceptChat(queueKey, clientId){
  chatId = db.ref("chats").push().key;
  partnerId = clientId;

  // mark astrologer busy
  db.ref("presence/"+userId).update({ busy:true });

  // assign chat to both users
  db.ref("currentChat").update({
    [userId]: chatId,
    [clientId]: chatId
  });

  // ‚úÖ SINGLE SOURCE OF TRUTH
  db.ref("chats/"+chatId+"/meta").set({
    astrologer: userId,
    client: clientId,
    started: Date.now(),
    active: true
  });

  db.ref("requests/"+userId+"/"+queueKey).remove();

if(role === "astrologer"){
  startCreditTimer(clientId, userId);
}
  openChat(chatId);
}
function buyCredits(amount){
  if(!userId){
    alert("Please login first");
    return;
  }

  let link = "";

  if(amount === 49){
    link = "";
  } 
  else if(amount === 99){
    link = "";
  } 
  else if(amount === 249){
    link = "";
  }

  if(!link){
    alert("Invalid package");
    return;
  }

  const email = auth.currentUser?.email || "unknown";

  // üî• IMPORTANT: PASS UID + EMAIL TO RAZORPAY
  const params =
    "?uid=" + encodeURIComponent(userId) +
    "&email=" + encodeURIComponent(email) +
    "&amount=" + amount +
    "&time=" + Date.now();

  alert(
    "Payment page will open.\n\n" +
    "Credits will be added within 24 hours.\n\n" +
    "Your User ID is saved automatically."
  );

  window.open(link + params, "_blank");
}

/* ================= OPEN CHAT ================= */
function openChat(id){
  if(chatView && !chatView.classList.contains("hidden") && chatId === id) return;

  chatId = id;

  clientView.classList.add("hidden");
  astrologerView.classList.add("hidden");
  chatView.classList.remove("hidden");
  messagesDiv.innerHTML = "";

  const metaRef = db.ref("chats/"+id+"/meta");

  // üî• REAL-TIME END DETECTION
metaRef.on("value", snap=>{
  const meta = snap.val();
  if(!meta || meta.active === false){
    metaRef.off();
    forceCloseChat(meta?.endReason || "Chat ended");
    return;
  }

  partnerId = meta.client === userId ? meta.astrologer : meta.client;

  // üî• FIX TIMER RESET (USE ORIGINAL START TIME)
  if(!chatStartTime && meta.started){
    chatStartTime = meta.started;
    startChatTimer();
  }
});

  if(chatRef) chatRef.off();
  chatRef = db.ref("chats/"+id+"/messages");

  chatRef.on("child_added", snap=>{
    const msg = snap.val();
    const div = document.createElement("div");
    div.className = "message " + (msg.from === userId ? "self" : "");
    div.textContent = (userCache[msg.from] || "User") + ": " + msg.text;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTo({ top: messagesDiv.scrollHeight, behavior:"smooth" });
  });
}

function forceCloseChat(message){
  stopChatTimer();

  const endedChatId = chatId; // ‚úÖ SAVE FIRST

  if(chatRef){
    chatRef.off();
    chatRef = null;
  }

  chatId = null;
  partnerId = null;

  chatView.classList.add("hidden");

  if(role === "astrologer" && endedChatId){
    db.ref("chats/"+endedChatId+"/meta/earned")
      .once("value")
      .then(snap=>{
        const earned = snap.val() || 0;
        alert(`Chat ended.\nYou earned ${earned} credits.`);
      });
  } else {
    if(message && message !== "silent"){
  alert(message);
}
  }

  if(role === "client"){
    clientView.classList.remove("hidden");
    astrologerView.classList.add("hidden");
  } else {
    astrologerView.classList.remove("hidden");
    clientView.classList.add("hidden");
  }
}

/* ================= SEND MESSAGE ================= */
function sendMessage(){
  if(!chatId) return;
  const text = msgInput.value.trim();
  if(!text) return;
  db.ref("chats/"+chatId+"/messages").push({ from:userId, text, time:Date.now() });
  msgInput.value="";
}

/* ================= EXIT CHAT ================= */
function exitChat(){
  if(creditInterval){
  clearInterval(creditInterval);
  creditInterval = null;
}
  if(!chatId) return;

  if(!confirm("End chat for both users?")) return;

  const endedChatId = chatId;

  // üî• AUTHORITATIVE END
  db.ref("chats/"+endedChatId+"/meta/active").set(false);
  db.ref("chats/"+endedChatId+"/meta").update({
  archived: true
});

  // remove assignments
  db.ref("currentChat/"+userId).remove();
  if(partnerId) db.ref("currentChat/"+partnerId).remove();

  // free astrologer
  if(role === "astrologer"){
    db.ref("presence/"+userId).update({ busy:false });
  } else if(partnerId){
    db.ref("presence/"+partnerId).update({ busy:false });
  }

 forceCloseChat("silent");
}
async function startCreditTimer(clientId, astrologerId){
  const clientRef = db.ref("presence/"+clientId);
  const astroRef = db.ref("presence/"+astrologerId);

  db.ref("chats/"+chatId+"/meta/earned").set(0);
  // üî• Mark first chat as used ONCE
db.ref("presence/"+clientId+"/firstChatUsed").set(true);

  creditInterval = setInterval(async () => {
    const clientSnap = await clientRef.get();
    const astroSnap = await astroRef.get();

    const credits = clientSnap.val().credits || 0;
    const rate = astroSnap.val().ratePerMinute || 1;
    const firstChatUsed = clientSnap.val().firstChatUsed;

let finalRate = rate;

// üî• APPLY DISCOUNT ONLY IF FIRST CHAT
if(firstChatUsed === false){
  finalRate = Math.ceil(rate * 0.90); // 10% OFF

  // üî• MARK USED ONLY ONCE (FIRST MINUTE)
  await clientRef.update({ firstChatUsed: true });
}

// üî• 10% discount ONLY for first chat (permanent)
let discountApplied = false;

if(firstChatUsed === false){
  finalRate = Math.ceil(rate * 0.90); // üî• 10% OFF
  discountApplied = true;
}

    if(credits < finalRate){
      endChat("Client ran out of credits");
      return;
    }

    await clientRef.update({
  credits: credits - finalRate
});

    await astroRef.child("credits")
      .transaction(c => (c || 0) + finalRate);

    db.ref("chats/"+chatId+"/meta/earned")
      .transaction(e => (e || 0) + finalRate);

    const todayKey = new Date().toLocaleDateString("en-CA");
    db.ref(`earnings/${astrologerId}/${todayKey}`)
      .transaction(e => (e || 0) + finalRate);

  }, 60000);
}

/* ================= Reset ================= */
  function resetEveryone(){
  if(!confirm("RESET ALL ONLINE USERS?")) return;

  db.ref("presence").once("value").then(snap=>{
    snap.forEach(child=>{
      db.ref("presence/"+child.key).update({
        online: false,
        role: "user",
        busy: false,
        lastSeen: Date.now()
      });
      db.ref("requests/"+child.key).remove();
      db.ref("currentChat/"+child.key).remove();
    });
  });

  alert("All users reset");
}

/* ================= LOAD USERNAMES CACHE ================= */
function loadUserCache(){
  db.ref("presence").once("value").then(snap=>{
    snap.forEach(child=>{
      userCache[child.key] = child.val().username;
    });
  });
}
  function watchCredits(){
  db.ref("presence/"+userId+"/credits").on("value", snap=>{
    const el = document.getElementById("creditBalance");
    if(el) el.textContent = snap.val() || 0;
  });
}
  function watchAstroRate(){
  db.ref("presence/"+userId+"/ratePerMinute").on("value", snap=>{
    const el = document.getElementById("astroRate");
    if(el){
      el.textContent = snap.val() || 0;
    }
  });
}
function updateRate(){
  if(chatId){
    alert("You cannot change rate during live chat");
    return;
  }

  const input = document.getElementById("rateInput");
  const rate = parseInt(input.value);

  if(!rate || rate < 1){
    alert("Rate must be 1 or more");
    return;
  }

  db.ref("presence/"+userId).update({
    ratePerMinute: rate
  });

  input.value = "";
}
let earningsRef = null;
const ONLINE_KEY = "astrolab_online";

function watchTodayEarnings(){
  if(!userId || role !== "astrologer") return;

  const todayKey = new Date().toLocaleDateString("en-CA");

  if(earningsRef){
    earningsRef.off();
  }

  earningsRef = db.ref(`earnings/${userId}/${todayKey}`);
  earningsRef.on("value", snap=>{
    const el = document.getElementById("todayEarnings");
    if(el) el.textContent = snap.val() || 0;
  });
}

function startChatTimer(){
  stopChatTimer();
  chatTimerInterval = setInterval(()=>{
    const diff = Date.now() - chatStartTime;
    const mins = Math.floor(diff / 60000);
    const secs = Math.floor((diff % 60000) / 1000);
    document.getElementById("chatTimer").textContent =
      `${String(mins).padStart(2,"0")}:${String(secs).padStart(2,"0")}`;
  }, 1000);
}

function stopChatTimer(){
  if(chatTimerInterval){
    clearInterval(chatTimerInterval);
    chatTimerInterval = null;
  }
}
function endChat(reason){
  stopChatTimer();
  if(creditInterval){
    clearInterval(creditInterval);
    creditInterval = null;
  }
setTimeout(()=>{
  if(chatId){
    db.ref("chats/" + chatId).remove();
  }
}, 5000);
  if(!chatId) return;

  db.ref("chats/"+chatId+"/meta").update({
    active: false,
    endedAt: Date.now(),
    endReason: reason
  });
}
async function changePassword() {
  const current = document.getElementById("currentPassword").value.trim();
  const newPass = document.getElementById("newPassword").value.trim();

  if (!current || !newPass) {
    alert("Enter current and new password");
    return;
  }

  const user = auth.currentUser;
  const cred = firebase.auth.EmailAuthProvider.credential(user.email, current);

  try {
    await user.reauthenticateWithCredential(cred);
    await user.updatePassword(newPass);
    alert("Password changed successfully");
    document.getElementById("currentPassword").value = "";
    document.getElementById("newPassword").value = "";
  } catch (err) {
    alert("Error: " + err.message);
  }
}
async function changeEmail() {
  const newEmail = document.getElementById("newEmail").value.trim();
  if (!newEmail) {
    alert("Enter new email");
    return;
  }

  const user = auth.currentUser;

  try {
    await user.updateEmail(newEmail);
    alert("Email updated");
    document.getElementById("linkedEmail").textContent = newEmail;
    document.getElementById("newEmail").value = "";
  } catch (err) {
    alert("Please login again to change email");
  }
}
function forgotPassword(){
  const email = document.getElementById("email").value.trim();

  if(!email){
    alert("Enter your email first");
    return;
  }

  auth.sendPasswordResetEmail(email)
    .then(()=>{
      alert("Password reset email sent");
    })
    .catch(err=>{
      alert(err.message);
    });
}
async function linkGoogle(){
  const provider = new firebase.auth.GoogleAuthProvider();
  const user = auth.currentUser;

  try {
    await user.linkWithPopup(provider);
    alert("Google account linked");
    location.reload();
  } catch (err) {
    alert(err.message);
  }
}
function hasEmailProvider(user){
  return user.providerData.some(p => p.providerId === "password");
}

async function unlinkGoogle(){
  const user = auth.currentUser;

  try {
    if(!hasEmailProvider(user)){
  alert("Add email/password before unlinking Google");
  return;
}
await user.unlink("google.com");
    alert("Google account unlinked");
    location.reload();
  } catch (err) {
    alert(err.message);
  }
}
function clearMyRequests(){
  if(!userId) return;
  db.ref("requests/" + userId).remove();
}
let selectedStars = {};

function renderStars(astroId){
  const box = document.getElementById("stars_"+astroId);
  box.innerHTML = "";
  for(let i=1;i<=5;i++){
    const star = document.createElement("i");
star.className = "fa-solid fa-star";
if(i <= (selectedStars[astroId] || 0)) star.classList.add("active");
    if(i <= (selectedStars[astroId] || 0)) star.classList.add("active");
    star.onclick = ()=>{
      selectedStars[astroId] = i;
      renderStars(astroId);
    };
    box.appendChild(star);
  }
}
function submitReview(astroId){
  if(!userId) return alert("Login first");

  const stars = selectedStars[astroId];
  if(!stars) return alert("Select stars");

  const text =
    document.getElementById("reviewText_"+astroId).value.trim();

db.ref(`reviews/${astroId}`).push({
  userId,
  stars,
  text,
  time: Date.now()
});

  document.getElementById("reviewText_"+astroId).value = "";
}
function loadReviews(astroId){
  const listBox = document.getElementById("reviews_"+astroId);
  const statsBox = document.getElementById("reviewStats_"+astroId);
  const ref = db.ref("reviews/"+astroId);

  ref.off();
  ref.on("value", snap=>{
    listBox.innerHTML = "";

    let counts = {1:0,2:0,3:0,4:0,5:0};
    let total = 0;

    snap.forEach(r=>{
      const d = r.val();
      counts[d.stars] = (counts[d.stars] || 0) + 1;
      total++;
    });

    // üî• STATS HEADER
    statsBox.innerHTML = `
      <div><strong>Total Reviews:</strong> ${total}</div>
      <div>‚≠ê5: ${counts[5] || 0}</div>
      <div>‚≠ê4: ${counts[4] || 0}</div>
      <div>‚≠ê3: ${counts[3] || 0}</div>
      <div>‚≠ê2: ${counts[2] || 0}</div>
      <div>‚≠ê1: ${counts[1] || 0}</div>
    `;

    // üî• LIST
    snap.forEach(r=>{
      const d = r.val();
      const reviewId = r.key;
      const reviewer = userCache[d.userId] || "User";

      const div = document.createElement("div");
      div.className = "review-item";

      let del = "";
      if(userId === astroId || userId === d.userId){
        del = `<button class="review-delete"
          onclick="deleteReview('${astroId}','${reviewId}')">
          Delete</button>`;
      }

      div.innerHTML = `
        <div class="review-user">${reviewer}</div>
        <div class="review-stars">${"‚≠ê".repeat(d.stars)}</div>
        <div>${d.text || ""}</div>
        ${del}
      `;

      listBox.appendChild(div);
    });
  });
}

function deleteReview(astroId, reviewId){
  if(!confirm("Delete this review?")) return;
  db.ref(`reviews/${astroId}/${reviewId}`).remove();
}

</script>

</body>
</html>
