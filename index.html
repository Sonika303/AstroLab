<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AstroLab</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body {margin:0;font-family:Arial,sans-serif;background:#f4f6f8;display:flex;height:100vh;}
.sidebar {width:230px;background:#fff;border-right:1px solid #ddd;padding:15px;}
.sidebar h2 {margin-bottom:20px;}
.sidebar button {width:100%;padding:10px;margin-bottom:10px;cursor:pointer;}
.main {flex:1;padding:20px;overflow-y:auto;}
.card {background:#fff;border:1px solid #ddd;border-radius:8px;padding:15px;margin-bottom:10px;}
.hidden {display:none;}
.chat-box {height:300px;border:1px solid #ddd;padding:10px;overflow-y:auto;background:#fff;}
input,button {padding:8px;margin-top:5px;}
</style>
</head>

<body>

<div class="sidebar">
  <h2>AstroLab</h2>
  <button onclick="switchRole('client')">Client</button>
  <button onclick="switchRole('astrologer')">Astrologer</button>
</div>

<div class="main">

  <!-- CLIENT VIEW -->
  <div id="clientView">
    <h3>Online Astrologers</h3>
    <div id="astrologerList"></div>
  </div>

  <!-- ASTROLOGER VIEW -->
  <div id="astrologerView" class="hidden">
    <h3>Astrologer Dashboard</h3>
    <label><input type="checkbox" onchange="toggleOnline(this.checked)"> Go Online</label>
    <h4>Chat Requests Queue</h4>
    <div id="requestList"></div>
  </div>

  <!-- CHAT VIEW -->
  <div id="chatView" class="hidden">
    <h3>Live Chat</h3>
    <div class="chat-box" id="messages"></div>
    <input id="msgInput" placeholder="Type message">
    <br>
    <button onclick="sendMessage()">Send</button>
    <button id="exitBtn" onclick="exitChat()">Exit Chat</button>
  </div>

</div>

<script>
/* ================= FIREBASE CONFIG ================= */
const firebaseConfig = {
  apiKey: "AIzaSyALzPqt1EdWG9cWeFf2gZP8Z470D0puPds",
  authDomain: "astrolab-b8956.firebaseapp.com",
  databaseURL: "https://astrolab-b8956-default-rtdb.firebaseio.com",
  projectId: "astrolab-b8956"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ================= STATE ================= */
const userId = "user_" + Math.random().toString(36).slice(2);
let role = "client";
let chatId = null;
let currentPartner = null;
let chatListener = null;
let queueListener = null;

/* ================= NOTIFICATIONS ================= */
if("Notification" in window) Notification.requestPermission();

/* ================= ROLE SWITCH ================= */
function switchRole(r){
  role = r;
  document.getElementById("clientView").classList.toggle("hidden",r!=="client");
  document.getElementById("astrologerView").classList.toggle("hidden",r!=="astrologer");
  document.getElementById("chatView").classList.add("hidden");
  document.getElementById("exitBtn").style.display = (r==="client"?"inline-block":"none");
}

/* ================= PRESENCE ================= */
function toggleOnline(isOnline){
  const ref = db.ref("presence/"+userId);
  if(isOnline){
    ref.set({role:"astrologer",busy:false});
    ref.onDisconnect().remove();
    listenQueue();
  } else {
    ref.remove();
    if(queueListener){ queueListener.off(); queueListener=null; }
  }
}

/* ================= SHOW ONLINE ASTROLOGERS ================= */
db.ref("presence").on("value",snap=>{
  const list = document.getElementById("astrologerList");
  list.innerHTML="";
  snap.forEach(c=>{
    if(c.val().role==="astrologer"){
      const card=document.createElement("div");
      card.className="card";
      card.innerHTML=`<strong>${c.key}</strong> ${c.val().busy?"(Busy)":""}<br>
        <button onclick="requestChat('${c.key}')" ${c.key===userId?"disabled":""}>Request Chat</button>`;
      list.appendChild(card);
    }
  });
});

/* ================= CLIENT CHAT REQUEST ================= */
function requestChat(astrologerId){
  if(astrologerId===userId) return alert("Cannot request chat to yourself");
  db.ref("presence/"+astrologerId).once("value",snap=>{
    if(!snap.exists() || snap.val().busy) return alert("Astrologer busy/offline");
    const queueRef = db.ref("queue/"+astrologerId).push();
    queueRef.set({client:userId});
    if(Notification.permission==="granted"){
      new Notification("Chat request sent",{body:`Queued with ${astrologerId}`});
    }
  });
}

/* ================= ASTROLOGER QUEUE ================= */
function listenQueue(){
  queueListener = db.ref("queue/"+userId);
  queueListener.on("value",snap=>{
    const box=document.getElementById("requestList");
    box.innerHTML="";
    snap.forEach(r=>{
      const clientId = r.val().client;
      if(!r.val().chatStarted){
        const card=document.createElement("div");
        card.className="card";
        card.innerHTML=`Request from ${clientId}<br>
          <button onclick="acceptQueue('${r.key}','${clientId}')">Accept</button>
          <button onclick="rejectQueue('${r.key}')">Reject</button>`;
        box.appendChild(card);
        if(Notification.permission==="granted"){
          new Notification("New chat queued",{body:`Client ${clientId} wants to chat`});
        }
      }
    });
  });
}

/* ================= ACCEPT / REJECT QUEUE ================= */
function acceptQueue(queueKey,clientId){
  if(chatId) return alert("Already in a chat");
  chatId = db.ref().push().key;
  currentPartner = clientId;
  db.ref("presence/"+userId).update({busy:true});
  db.ref(`chats/${chatId}`).set({participants:{[userId]:true,[clientId]:true},messages:{}});
  db.ref(`queue/${userId}/${queueKey}`).update({chatStarted:true});
  db.ref(`currentChat/${clientId}`).set(chatId);
  openChat(chatId);
}

function rejectQueue(queueKey){
  db.ref(`queue/${userId}/${queueKey}`).remove();
}

/* ================= CLIENT LISTEN FOR ASSIGNMENT ================= */
db.ref(`currentChat/${userId}`).on("value",snap=>{
  if(snap.exists()){
    chatId = snap.val();
    openChat(chatId);
  }
});

/* ================= CHAT ================= */
function openChat(id){
  document.getElementById("chatView").classList.remove("hidden");
  const box=document.getElementById("messages");
  box.innerHTML="";
  if(chatListener) chatListener.off();
  chatListener = db.ref(`chats/${id}/messages`);
  chatListener.on("child_added",snap=>{
    const p=document.createElement("div");
    p.textContent = snap.val().from+": "+snap.val().text;
    box.appendChild(p);
    box.scrollTop = box.scrollHeight;
  });
}

function sendMessage(){
  if(!chatId) return;
  const text = msgInput.value.trim();
  if(!text) return;
  db.ref(`chats/${chatId}/messages`).push({from:userId,text});
  msgInput.value="";
}

/* ================= EXIT CHAT ================= */
function exitChat(){
  if(!chatId) return;
  if(chatListener){ chatListener.off(); chatListener=null; }
  db.ref(`chats/${chatId}`).remove();
  if(role==="client") db.ref(`currentChat/${userId}`).remove();
  if(role==="astrologer" && currentPartner) db.ref(`currentChat/${currentPartner}`).remove();
  if(role==="astrologer") db.ref(`presence/${userId}`).update({busy:false});
  chatId=null;
  currentPartner=null;
  document.getElementById("chatView").classList.add("hidden");
}
</script>

</body>
</html>
