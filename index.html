<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AstroLab</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<style>
* { box-sizing: border-box; transition: all 0.3s ease; }
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #f4f6f8;
  display: flex;
  height: 100vh;
  overflow: hidden;
}
.sidebar {
  width: 240px;
  background: #fff;
  border-right: 1px solid #ddd;
  padding: 15px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.sidebar button {
  padding: 10px;
  border: none;
  background: #007bff;
  color: white;
  cursor: pointer;
  border-radius: 6px;
}
  .settings {
  position: fixed;
  right: -300px;
  top: 0;
  width: 300px;
  height: 100%;
  background: #ffffff;
  border-left: 1px solid #ddd;
  padding: 15px;
  z-index: 1000;
  transition: right 0.3s ease;
  overflow-y: auto;
}
.settings.open { right: 0; }

.settings h3 { margin-top: 0; }

.avatar {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  object-fit: cover;
  margin-bottom: 10px;
}

.sidebar button:hover { background: #0056b3; }

.main { 
  flex: 1; 
  padding: 20px; 
  overflow-y: auto; 
}

.card {
  background: #fff;
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 15px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
}
.card:hover { transform: translateY(-2px); }

.chat-box { 
  height: 320px; 
  border: 1px solid #ddd; 
  background: #fff; 
  padding: 10px; 
  overflow-y: auto; 
  margin-bottom: 10px; 
  border-radius: 6px;
}

.hidden { display: none; }
input, button, textarea { 
  padding: 8px; 
  margin-top: 5px; 
  width: 100%; 
  border-radius: 6px; 
  border: 1px solid #ccc;
}
button { cursor: pointer; }
#error { color: red; font-weight: bold; }

.message {
  margin-bottom: 8px;
  padding: 6px 10px;
  border-radius: 6px;
  background: #e2e6ea;
  max-width: 70%;
  word-wrap: break-word;
}
.message.self { background: #007bff; color: white; margin-left: auto; }
</style>
</head>
  
  <div id="settingsPanel" class="settings">
  <h3>Account Settings</h3>

  <img id="avatarPreview" class="avatar" src="" alt="Avatar">
  <input type="file" id="avatarInput" accept="image/*">

  <input id="s_name" placeholder="Display Name">
  <input id="s_speciality" placeholder="Speciality">
  <textarea id="s_desc" placeholder="Description"></textarea>

  <button onclick="saveSettings()">Save</button>
</div>

<body>

<div class="sidebar">
  <h2>AstroLab</h2>
  <div id="secretReset" style="height:20px; opacity:0;" onclick="secretTap()"></div>
  <button onclick="switchRole('client')">Client</button>
  <button onclick="switchRole('astrologer')">Astrologer</button>
  <button onclick="toggleSettings()">Settings</button>
</div>

<div class="main">

  <!-- AUTH -->
  <div id="authCard" class="card">
    <h3>Login / Signup</h3>
    <input id="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
    <input id="username" placeholder="Username (unique)">
    <button onclick="signup()">Signup</button>
    <button onclick="login()">Login</button>
    <button onclick="googleLogin()">Sign in with Google</button>
    <p id="error"></p>
  </div>

  <!-- PROFILE SETTINGS -->
  <div id="profileCard" class="card hidden">
    <h3>Profile Settings</h3>
    <input id="p_username" placeholder="Username">
    <input id="p_speciality" placeholder="Speciality">
    <textarea id="p_desc" placeholder="Description"></textarea>
    <button onclick="saveProfile()">Save</button>
    <button onclick="logout()">Logout</button>
  </div>

  <!-- CLIENT VIEW -->
  <div id="clientView" class="hidden">
    <h3>Online Astrologers</h3>
    <div id="astrologerList"></div>
  </div>

  <!-- ASTROLOGER VIEW -->
  <div id="astrologerView" class="hidden">
    <h3>Astrologer Dashboard</h3>
    <label>
      <input type="checkbox" onchange="toggleOnline(this.checked)"> Go Online
    </label>
    <h4>Chat Queue</h4>
    <div id="queueList"></div>
  </div>

  <!-- CHAT VIEW -->
  <div id="chatView" class="hidden">
    <h3>Live Chat</h3>
    <div class="chat-box" id="messages"></div>
    <input id="msgInput" placeholder="Type message..." />
    <br>
    <button onclick="sendMessage()">Send</button>
    <button onclick="exitChat()">Exit Chat</button>
  </div>

</div>

<script>
/* ================= FIREBASE CONFIG ================= */
const firebaseConfig = {
  apiKey: "AIzaSyALzPqt1EdWG9cWeFf2gZP8Z470D0puPds",
  authDomain: "astrolab-b8956.firebaseapp.com",
  databaseURL: "https://astrolab-b8956-default-rtdb.firebaseio.com",
  projectId: "astrolab-b8956",
  storageBucket: "astrolab-b8956.appspot.com",
  messagingSenderId: "000000000000",
  appId: "1:000000000000:web:000000000000"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();
const storage = firebase.storage();
const connectedRef = db.ref(".info/connected");

/* ================= STATE ================= */
let userId = null;
let role = "client";
let chatId = null;
let partnerId = null;
let chatRef = null;
let queueRef = null;
let userCache = {}; // cache usernames

/* ================= ELEMENTS ================= */
const authCard = document.getElementById("authCard");
const profileCard = document.getElementById("profileCard");
const clientView = document.getElementById("clientView");
const astrologerView = document.getElementById("astrologerView");
const chatView = document.getElementById("chatView");
const error = document.getElementById("error");
const astrologerList = document.getElementById("astrologerList");
const queueList = document.getElementById("queueList");
const messagesDiv = document.getElementById("messages");
const msgInput = document.getElementById("msgInput");
const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const usernameInput = document.getElementById("username");
const p_username = document.getElementById("p_username");
const p_speciality = document.getElementById("p_speciality");
const p_desc = document.getElementById("p_desc");

const avatarInput = document.getElementById("avatarInput");
const avatarPreview = document.getElementById("avatarPreview");
const s_name = document.getElementById("s_name");
const s_speciality = document.getElementById("s_speciality");
const s_desc = document.getElementById("s_desc");

/* ================= AUTH STATE ================= */
auth.onAuthStateChanged(user => {
  if(user){
    userId = user.uid;

    authCard.classList.add("hidden");
    profileCard.classList.remove("hidden");
    clientView.classList.remove("hidden");
    astrologerView.classList.add("hidden");
    chatView.classList.add("hidden");

    loadProfile();
    loadUserCache();

 // ðŸ”¥ CHAT OPEN + CHAT END LISTENER
db.ref("currentChat/" + userId).off();
db.ref("currentChat/" + userId).on("value", snap => {
  if (snap.exists()) {
    if (!chatId || chatId !== snap.val()) {
      openChat(snap.val());
    }
  } else {
    // ðŸ”¥ chat ended by other user
    forceCloseChat("Chat ended");
  }
});
;

  } else {
    userId = null;

    authCard.classList.remove("hidden");
    profileCard.classList.add("hidden");
    clientView.classList.add("hidden");
    astrologerView.classList.add("hidden");
    chatView.classList.add("hidden");
  }
});


/* ================= ERROR ================= */
function showError(msg){ error.textContent = msg; }
function toggleSettings(){
document.getElementById("settingsPanel").classList.toggle("open");
}
  let tapCount = 0;
function secretTap(){
  tapCount++;
  if(tapCount >= 5){
    tapCount = 0;
    resetEveryone();
  }
}



/* ================= SIGNUP ================= */
function signup(){
  const e = emailInput.value;
  const p = passwordInput.value;
  const u = usernameInput.value.trim().toLowerCase();
  if(!u) return showError("Username required");

  db.ref("presence").once("value").then(snap=>{
    let taken=false;
    snap.forEach(c=>{ if(c.val().username===u) taken=true; });
    if(taken) return showError("Username already in use");

    auth.createUserWithEmailAndPassword(e,p)
      .then(res=>{
        userId = res.user.uid;
db.ref("presence/"+userId).set({
  username: u,
  speciality: "",
  description: "",
  role: "user",
  busy: false,
  online: false,
  lastSeen: Date.now()
});
      }).catch(err=>showError(err.message));
  });
}

/* ================= LOGIN ================= */
function login(){
  auth.signInWithEmailAndPassword(emailInput.value,passwordInput.value).catch(err=>showError(err.message));
}

/* ================= GOOGLE LOGIN ================= */
function googleLogin(){
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider).then(res=>{
    userId = res.user.uid;
    db.ref("presence/"+userId).once("value").then(snap=>{
      if(!snap.exists()) db.ref("presence/"+userId).set({
  username: "user_"+userId.slice(0,6),
  speciality: "",
  description: "",
  role: "user",
  busy: false,
  online: false,
  lastSeen: Date.now()
});

    });
  }).catch(err=>showError(err.message));
}

/* ================= LOAD PROFILE ================= */
function loadProfile(){
  db.ref("presence/"+userId).once("value").then(snap=>{
    const d = snap.val(); if(!d) return;

    p_username.value = d.username || "";
    p_speciality.value = d.speciality || "";
    p_desc.value = d.description || "";

    s_name.value = d.username || "";
    s_speciality.value = d.speciality || "";
    s_desc.value = d.description || "";

   if(d.avatar){
  avatarPreview.src = d.avatar;
} else {
  avatarPreview.src = "https://via.placeholder.com/80";
}

  });
}


/* ================= SAVE PROFILE ================= */
function saveProfile(){
  const uname = p_username.value.trim().toLowerCase();
  if(!uname) return showError("Username required");

  db.ref("presence").once("value").then(snap=>{
    let taken=false;
    snap.forEach(c=>{ if(c.key!==userId && c.val().username===uname) taken=true; });
    if(taken) return showError("Username already in use");

    db.ref("presence/"+userId).update({ username:uname, speciality:p_speciality.value, description:p_desc.value });
    alert("Profile saved");
  });
}

/* ================= LOGOUT ================= */
function logout(){ auth.signOut(); }
function saveSettings(){
  const file = avatarInput.files[0];
  const name = s_name.value.trim().toLowerCase();
  if(!name) return showError("Name required");

  if(file){
    const ref = storage.ref(`avatars/${userId}.jpg`);
    ref.put(file, { contentType: file.type }).then(()=>{
      return ref.getDownloadURL();
    }).then(url=>{
      updateProfile(name, url);
      avatarPreview.src = url;
    }).catch(err=>showError(err.message));
  } else {
    updateProfile(name, null);
  }
}


function updateProfile(name, avatar){
  const data = {
    username: name,
    speciality: s_speciality.value,
    description: s_desc.value
  };
  if(avatar) data.avatar = avatar;
  db.ref("presence/"+userId).update(data);
}


/* ================= ROLE SWITCH ================= */
function switchRole(r){
  role = r;
  clientView.classList.toggle("hidden", r!=="client");
  astrologerView.classList.toggle("hidden", r!=="astrologer");
  chatView.classList.add("hidden");
}

/* ================= ASTROLOGER ONLINE ================= */
function toggleOnline(isOnline){
  const ref = db.ref("presence/"+userId);

  if(isOnline){
    connectedRef.on("value", snap=>{
      if(snap.val() === true){
        ref.update({
          role: "astrologer",
          busy: false,
          online: true,
          lastSeen: Date.now()
        });

        ref.onDisconnect().update({
          online: false,
          role: "user",
          busy: false,
          lastSeen: Date.now()
        });
      }
    });

    startQueueListener();
  } else {
    stopQueueListener();
    ref.update({
      online: false,
      role: "user",
      busy: false,
      lastSeen: Date.now()
    });
  }
}


/* ================= QUEUE LISTENER ================= */
function startQueueListener(){
  queueList.innerHTML="";
  queueRef = db.ref("requests/"+userId);
  queueRef.off();
 queueRef.on("child_added", snap=>{
  const data = snap.val();
  const clientName = userCache[data.client] || data.client;

  const div = document.createElement("div");
  div.className = "card";
  div.id = "req_" + snap.key;

  div.innerHTML = `
    Request from <strong>${clientName}</strong><br>
    <button onclick="acceptChat('${snap.key}','${data.client}')">Accept</button>
  `;

  queueList.appendChild(div);
});

queueRef.on("child_removed", snap=>{
  const el = document.getElementById("req_" + snap.key);
  if(el) el.remove();
});

}
function stopQueueListener(){ if(queueRef) queueRef.off(); queueList.innerHTML=""; }

/* ================= CLIENT VIEW ================= */
db.ref("presence").on("value", snap=>{
  astrologerList.innerHTML="";
  snap.forEach(child=>{
    const data = child.val();
if(data.role === "astrologer" && data.online === true && !data.busy){
      const uname = data.username || child.key;
      const div=document.createElement("div");
      div.className="card";
div.innerHTML = `
  <img src="${data.avatar || 'https://via.placeholder.com/80'}" class="avatar">
  <strong>${uname}</strong><br>
  <small>${data.speciality || "Astrology"}</small>
  <p>${data.description || ""}</p>
  <button onclick="requestChat('${child.key}')" ${data.busy?"disabled":""}>
    ${data.busy ? "Busy" : "Request Chat"}
  </button>
`;

      astrologerList.appendChild(div);
    }
    // cache usernames
    userCache[child.key] = data.username;
  });
});

/* ================= SEND REQUEST ================= */
function requestChat(astrologerId){
  db.ref("requests/"+astrologerId).push({ client:userId, time:Date.now() });
  alert("Chat request sent");
}

/* ================= ACCEPT CHAT ================= */
function acceptChat(queueKey, clientId){
  chatId = db.ref("chats").push().key;
  partnerId = clientId;

  // mark astrologer busy
  db.ref("presence/"+userId).update({ busy:true });

  // assign chat to both users
  db.ref("currentChat").update({
    [userId]: chatId,
    [clientId]: chatId
  });

  // âœ… SINGLE SOURCE OF TRUTH
  db.ref("chats/"+chatId+"/meta").set({
    astrologer: userId,
    client: clientId,
    started: Date.now(),
    active: true
  });

  db.ref("requests/"+userId+"/"+queueKey).remove();

  openChat(chatId);
}

/* ================= OPEN CHAT ================= */
function openChat(id){
  if(chatView && !chatView.classList.contains("hidden") && chatId === id) return;

  chatId = id;

  clientView.classList.add("hidden");
  astrologerView.classList.add("hidden");
  chatView.classList.remove("hidden");
  messagesDiv.innerHTML = "";

  const metaRef = db.ref("chats/"+id+"/meta");

  // ðŸ”¥ REAL-TIME END DETECTION
  metaRef.on("value", snap=>{
    const meta = snap.val();
    if(!meta || meta.active === false){
      metaRef.off();
      forceCloseChat("Chat ended by other user");
      return;
    }

    partnerId = meta.client === userId ? meta.astrologer : meta.client;
  });

  if(chatRef) chatRef.off();
  chatRef = db.ref("chats/"+id+"/messages");

  chatRef.on("child_added", snap=>{
    const msg = snap.val();
    const div = document.createElement("div");
    div.className = "message " + (msg.from === userId ? "self" : "");
    div.textContent = (userCache[msg.from] || "User") + ": " + msg.text;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });
}
  
function forceCloseChat(message){
  if(chatRef){ chatRef.off(); chatRef = null; }

  chatId = null;
  partnerId = null;

  chatView.classList.add("hidden");

  if(role === "client"){
    clientView.classList.remove("hidden");
    astrologerView.classList.add("hidden");
  } else {
    astrologerView.classList.remove("hidden");
    clientView.classList.add("hidden");
  }

  alert(message);
}

/* ================= SEND MESSAGE ================= */
function sendMessage(){
  if(!chatId) return;
  const text = msgInput.value.trim();
  if(!text) return;
  db.ref("chats/"+chatId+"/messages").push({ from:userId, text, time:Date.now() });
  msgInput.value="";
}

/* ================= EXIT CHAT ================= */
function exitChat(){
  if(!chatId) return;

  if(!confirm("End chat for both users?")) return;

  const endedChatId = chatId;

  // ðŸ”¥ AUTHORITATIVE END
  db.ref("chats/"+endedChatId+"/meta/active").set(false);

  // remove assignments
  db.ref("currentChat/"+userId).remove();
  if(partnerId) db.ref("currentChat/"+partnerId).remove();

  // free astrologer
  if(role === "astrologer"){
    db.ref("presence/"+userId).update({ busy:false });
  } else if(partnerId){
    db.ref("presence/"+partnerId).update({ busy:false });
  }

  forceCloseChat("You ended the chat");
}


/* ================= Reset ================= */
  function resetEveryone(){
  if(!confirm("RESET ALL ONLINE USERS?")) return;

  db.ref("presence").once("value").then(snap=>{
    snap.forEach(child=>{
      db.ref("presence/"+child.key).update({
        online: false,
        role: "user",
        busy: false,
        lastSeen: Date.now()
      });
      db.ref("requests/"+child.key).remove();
      db.ref("currentChat/"+child.key).remove();
    });
  });

  alert("All users reset");
}
  
/* ================= LOAD USERNAMES CACHE ================= */
function loadUserCache(){
  db.ref("presence").once("value").then(snap=>{
    snap.forEach(child=>{ userCache[child.key] = child.val().username; });
  });
}
</script>

</body>
</html>
