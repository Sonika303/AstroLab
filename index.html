<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AstroLab</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial;background:#f4f6f8;display:flex;height:100vh}
.sidebar{width:240px;background:#fff;border-right:1px solid #ddd;padding:15px}
.main{flex:1;padding:20px;overflow-y:auto}
.card{background:#fff;border-radius:8px;padding:15px;margin-bottom:15px;box-shadow:0 2px 6px rgba(0,0,0,.1)}
.chat-box{height:320px;border:1px solid #ddd;background:#fff;padding:10px;overflow-y:auto}
.message{margin-bottom:6px;padding:6px 10px;border-radius:6px;background:#e9ecef;max-width:75%}
.self{background:#007bff;color:#fff;margin-left:auto}
.system{background:#ffe6e6;color:#b30000;font-style:italic}
.hidden{display:none}
#timer{font-weight:bold;margin-bottom:10px}
.credit-red{color:red;font-weight:bold}
</style>
</head>

<body>

<div class="sidebar">
  <h2>AstroLab</h2>
  <button onclick="switchRole('client')">Client</button>
  <button onclick="switchRole('astrologer')">Astrologer</button>
</div>

<div class="main">

<div id="authCard" class="card">
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <input id="username" placeholder="Username">
  <button onclick="signup()">Signup</button>
  <button onclick="login()">Login</button>
  <button onclick="googleLogin()">Google Login</button>
  <p id="error"></p>
</div>

<div id="profileCard" class="card hidden">
  <h3>Profile</h3>
  <input id="p_username" placeholder="Username">
  <input id="p_speciality" placeholder="Speciality">
  <textarea id="p_desc" placeholder="Description"></textarea>
  <button onclick="saveProfile()">Save</button>
  <button onclick="logout()">Logout</button>
</div>

<div id="clientView" class="hidden">
  <h3>Credits: <span id="clientCredits"></span></h3>
  <div id="astrologerList"></div>
</div>

<div id="astrologerView" class="hidden">
  <h3>Astrologer Dashboard</h3>
  <label><input type="checkbox" onchange="toggleOnline(this.checked)"> Go Online</label>
  <p>Today's Login Time: <span id="loginTime">0</span> mins</p>
  <p>Today's Earnings: â‚¹<span id="todayEarnings">0</span></p>
  <div id="queueList"></div>
</div>

<div id="chatView" class="hidden">
  <div id="timer">00:00</div>
  <div class="chat-box" id="messages"></div>
  <input id="msgInput">
  <button onclick="sendMessage()">Send</button>
  <button onclick="confirmEnd()">End Chat</button>
</div>

</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyALzPqt1EdWG9cWeFf2gZP8Z470D0puPds",
  authDomain:"astrolab-b8956.firebaseapp.com",
  databaseURL:"https://astrolab-b8956-default-rtdb.firebaseio.com",
  projectId:"astrolab-b8956"
});

const auth=firebase.auth(),db=firebase.database();
let userId,role="client",chatId,partnerId,chatStart,timerInt,loginTick;

const today=()=>new Date().toISOString().split("T")[0];
const $=id=>document.getElementById(id);

/* AUTH */
auth.onAuthStateChanged(u=>{
  if(!u) return;
  userId=u.uid;
  $("authCard").classList.add("hidden");
  $("profileCard").classList.remove("hidden");
  loadProfile();
  loadCredits();
  listenChat();
});

/* SIGNUP / LOGIN */
function signup(){
  auth.createUserWithEmailAndPassword(email.value,password.value)
  .then(r=>{
    db.ref("users/"+r.user.uid).set({credits:50});
    db.ref("presence/"+r.user.uid).set({
      username:username.value.toLowerCase(),
      speciality:"",
      description:"",
      role:"user",
      busy:false
    });
  }).catch(e=>error.textContent=e.message);
}
function login(){auth.signInWithEmailAndPassword(email.value,password.value)}
function googleLogin(){
  const p=new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(p).then(r=>{
    db.ref("users/"+r.user.uid).once("value").then(s=>{
      if(!s.exists()) db.ref("users/"+r.user.uid).set({credits:50});
    });
    db.ref("presence/"+r.user.uid).once("value").then(s=>{
      if(!s.exists()){
        db.ref("presence/"+r.user.uid).set({
          username:"user_"+r.user.uid.slice(0,6),
          speciality:"",
          description:"",
          role:"user",
          busy:false
        });
      }
    });
  });
}

/* PROFILE */
function loadProfile(){
  db.ref("presence/"+userId).once("value").then(s=>{
    p_username.value=s.val().username;
    p_speciality.value=s.val().speciality;
    p_desc.value=s.val().description;
  });
}
function saveProfile(){
  db.ref("presence/"+userId).update({
    username:p_username.value,
    speciality:p_speciality.value,
    description:p_desc.value
  });
}

/* CREDITS */
function loadCredits(){
  db.ref("users/"+userId+"/credits").on("value",s=>{
    $("clientCredits").textContent=s.val();
  });
}

/* ROLE */
function switchRole(r){
  role=r;
  $("clientView").classList.toggle("hidden",r!=="client");
  $("astrologerView").classList.toggle("hidden",r!=="astrologer");
}

/* ASTROLOGER ONLINE */
function toggleOnline(v){
  const ref=db.ref("presence/"+userId);
  if(v){
    ref.update({role:"astrologer",busy:false});
    startLoginTimer();
    listenQueue();
  }else{
    stopLoginTimer();
    ref.update({role:"user",busy:false});
  }
}

/* LOGIN TIMER */
function startLoginTimer(){
  const ref=db.ref("astrologerStats/"+userId+"/"+today()+"/loginSeconds");
  loginTick=setInterval(()=>ref.transaction(v=>(v||0)+1),1000);
}
function stopLoginTimer(){clearInterval(loginTick)}

/* QUEUE */
function listenQueue(){
  const ref=db.ref("requests/"+userId);
  ref.off();
  ref.on("child_added",s=>{
    const d=s.val();
    const div=document.createElement("div");
    div.className="card";
    div.innerHTML=`Request from ${d.client}
    <button onclick="acceptChat('${s.key}','${d.client}')">Accept</button>`;
    queueList.appendChild(div);
  });
}

/* CLIENT VIEW */
db.ref("presence").on("value",s=>{
  astrologerList.innerHTML="";
  s.forEach(c=>{
    const d=c.val();
    if(d.role==="astrologer"){
      const div=document.createElement("div");
      div.className="card";
      div.innerHTML=`<b>${d.username}</b> (${d.speciality})<br>
      ${d.busy?"Busy":"Online"}<br>
      <button ${d.busy?"disabled":""} onclick="requestChat('${c.key}')">Request</button>`;
      astrologerList.appendChild(div);
    }
  });
});

/* REQUEST */
function requestChat(id){
  db.ref("presence/"+id).once("value").then(s=>{
    if(s.val().busy) return alert("Busy");
    db.ref("requests/"+id).push({client:userId,time:Date.now()});
  });
}

/* ACCEPT */
function acceptChat(k,client){
  chatId=db.ref().push().key;
  partnerId=client;
  chatStart=Date.now();
  db.ref("chats/"+chatId).set({startedAt:chatStart});
  db.ref("currentChat/"+userId).set(chatId);
  db.ref("currentChat/"+client).set(chatId);
  db.ref("presence/"+userId).update({busy:true});
  db.ref("requests/"+userId+"/"+k).remove();
}

/* CHAT */
function listenChat(){
  db.ref("currentChat/"+userId).on("value",s=>{
    if(s.exists()) openChat(s.val());
  });
}
function openChat(id){
  chatId=id;
  $("chatView").classList.remove("hidden");
  messages.innerHTML="";
  startTimer();
  db.ref("chats/"+id+"/messages").on("child_added",s=>{
    const m=s.val();
    const d=document.createElement("div");
    d.className="message "+(m.system?"system":m.from===userId?"self":"");
    d.textContent=m.text;
    messages.appendChild(d);
  });
}

/* TIMER */
function startTimer(){
  timerInt=setInterval(()=>{
    const s=Math.floor((Date.now()-chatStart)/1000);
    timer.textContent=`${String(s/60|0).padStart(2,"0")}:${String(s%60).padStart(2,"0")}`;
  },1000);
}

/* SEND */
function sendMessage(){
  db.ref("chats/"+chatId+"/messages").push({from:userId,text:msgInput.value});
  msgInput.value="";
}

/* END CHAT */
function confirmEnd(){
  if(!confirm("End chat? Credits may be deducted")) return;
  const mins=Math.ceil((Date.now()-chatStart)/60000);
  if(role==="client"){
    db.ref("users/"+userId+"/credits").transaction(v=>v-mins);
    db.ref("astrologerStats/"+partnerId+"/"+today()+"/earnings")
      .transaction(v=>(v||0)+mins*10);
  }
  db.ref("chats/"+chatId+"/messages").push({
    system:true,
    text:`Chat ended by ${role.toUpperCase()} - ${mins} credits deducted`
  });
  db.ref("currentChat/"+userId).remove();
  db.ref("presence/"+userId).update({busy:false});
  clearInterval(timerInt);
  $("chatView").classList.add("hidden");
}
</script>

</body>
</html>
